name: Thea
options:
  bundleIdPrefix: app.thea
  deploymentTarget:
    macOS: "14.0"
    iOS: "17.0"
    watchOS: "10.0"
    tvOS: "17.0"
    visionOS: "2.0"
  xcodeVersion: "16.0"
  generateEmptyDirectories: true
  groupSortPosition: top
  developmentLanguage: en
  indentWidth: 4
  tabWidth: 4
  usesTabs: false
  defaultConfig: Release
  createIntermediateGroups: true
  transitivelyLinkDependencies: true

# ============================================
# Build Configurations
# ============================================
configs:
  Debug: debug
  Release: release

# ============================================
# Project-Level Build Settings
# ============================================
settings:
  base:
    # Version Information
    MARKETING_VERSION: "1.5.0"
    CURRENT_PROJECT_VERSION: "15"

    # Swift Configuration
    SWIFT_VERSION: "6.0"
    SWIFT_STRICT_CONCURRENCY: minimal
    SWIFT_EMIT_MODULE_INTERFACE: false
    BUILD_LIBRARY_FOR_DISTRIBUTION: false

    # Code Signing
    CODE_SIGN_STYLE: Automatic
    DEVELOPMENT_TEAM: 6B66PM4JLK

    # Build Options
    DEAD_CODE_STRIPPING: YES
    ENABLE_USER_SCRIPT_SANDBOXING: false
    CLANG_ENABLE_MODULES: true
    ENABLE_STRICT_OBJC_MSGSEND: YES
    GCC_NO_COMMON_BLOCKS: YES

    # Swift Package Dependencies
    SWIFT_INCLUDE_PATHS: "$(inherited)"

    # Localization (Xcode recommended)
    LOCALIZATION_EXPORT_SUPPORTED: YES
    SWIFT_EMIT_LOC_STRINGS: YES
    STRING_CATALOG_GENERATE_SYMBOLS: YES
    LOCALIZATION_PREFERS_STRING_CATALOGS: YES

    # Asset Catalog
    ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: YES

    # Warnings
    CLANG_ANALYZER_NONNULL: YES
    CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION: YES_AGGRESSIVE
    CLANG_WARN_DOCUMENTATION_COMMENTS: YES
    CLANG_WARN_UNGUARDED_AVAILABILITY: YES_AGGRESSIVE
    GCC_WARN_64_TO_32_BIT_CONVERSION: YES
    GCC_WARN_ABOUT_RETURN_TYPE: YES_ERROR
    GCC_WARN_UNDECLARED_SELECTOR: YES
    GCC_WARN_UNINITIALIZED_AUTOS: YES_AGGRESSIVE
    GCC_WARN_UNUSED_FUNCTION: YES
    GCC_WARN_UNUSED_VARIABLE: YES

    # Security
    ENABLE_NS_ASSERTIONS: NO

  configs:
    Debug:
      ONLY_ACTIVE_ARCH: YES
      SWIFT_ACTIVE_COMPILATION_CONDITIONS: DEBUG
      SWIFT_OPTIMIZATION_LEVEL: "-Onone"
      SWIFT_COMPILATION_MODE: singlefile
      DEBUG_INFORMATION_FORMAT: dwarf
      GCC_OPTIMIZATION_LEVEL: "0"
      ENABLE_TESTABILITY: YES
      ENABLE_NS_ASSERTIONS: YES
      MTL_ENABLE_DEBUG_INFO: INCLUDE_SOURCE
      COPY_PHASE_STRIP: NO
      GCC_DYNAMIC_NO_PIC: NO
      GCC_PREPROCESSOR_DEFINITIONS:
        - "$(inherited)"
        - "DEBUG=1"
    Release:
      ONLY_ACTIVE_ARCH: NO
      SWIFT_OPTIMIZATION_LEVEL: "-O"
      SWIFT_COMPILATION_MODE: wholemodule
      DEBUG_INFORMATION_FORMAT: "dwarf-with-dsym"
      COPY_PHASE_STRIP: NO
      ENABLE_NS_ASSERTIONS: NO
      MTL_FAST_MATH: YES
      VALIDATE_PRODUCT: YES
      LLVM_LTO: YES_THIN
      DEPLOYMENT_POSTPROCESSING: YES

# ============================================
# Package Dependencies
# ============================================
packages:
  OpenAI:
    url: https://github.com/MacPaw/OpenAI
    from: 0.2.0
  KeychainAccess:
    url: https://github.com/kishikawakatsumi/KeychainAccess
    from: 4.2.0
  MarkdownUI:
    url: https://github.com/gonzalezreal/swift-markdown-ui
    from: 2.0.0
  Highlightr:
    url: https://github.com/raspu/Highlightr
    from: 2.1.0

# ============================================
# Targets
# ============================================
targets:
  # ============ macOS App ============
  Thea-macOS:
    type: application
    platform: macOS
    deploymentTarget: "14.0"
    sources:
      - path: Shared
        excludes:
          - "**/*iOS*"
          - "**/*watchOS*"
          - "**/*tvOS*"
          - "**/*.md"
      - path: macOS
      - path: Shared/Resources/Assets.xcassets
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.macos
        PRODUCT_NAME: Thea
        PRODUCT_MODULE_NAME: TheaCore
        INFOPLIST_FILE: Shared/Resources/Info.plist
        CODE_SIGN_ENTITLEMENTS: macOS/Thea.entitlements
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
        MACOSX_DEPLOYMENT_TARGET: "14.0"
        COMBINE_HIDPI_IMAGES: true

        # Hardened Runtime (required for notarization)
        ENABLE_HARDENED_RUNTIME: YES

        # App Sandbox
        ENABLE_APP_SANDBOX: YES

        # Network Connections (build setting migration)
        ENABLE_INCOMING_NETWORK_CONNECTIONS: YES
        ENABLE_OUTGOING_NETWORK_CONNECTIONS: YES

        # App Groups
        REGISTER_APP_GROUPS: YES

        # Code Signing Identity
        CODE_SIGN_IDENTITY: "Apple Development"

        # Runpath Search Paths
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/../Frameworks"

      debug:
        CODE_SIGN_IDENTITY: "Apple Development"

      release:
        CODE_SIGN_IDENTITY: "Apple Distribution"
        SWIFT_TREAT_WARNINGS_AS_ERRORS: YES

    dependencies:
      - package: OpenAI
      - package: KeychainAccess
      - package: MarkdownUI
      - package: Highlightr
      - target: TheaFinderSyncExtension
        embed: true
        codeSign: true
      - target: TheaQuickLookExtension
        embed: true
        codeSign: true
      - target: TheaSafariExtensionMac
        embed: true
        codeSign: true

  # ============ iOS App ============
  Thea-iOS:
    type: application
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Shared
        excludes:
          - "**/*macOS*"
          - "**/*watchOS*"
          - "**/*tvOS*"
          - "**/*.md"
          - "**/Terminal/**"
          - "**/ScreenCapture.swift"
          - "**/InputTrackingManager.swift"
          - "**/*AutomationEngine.swift"
          - "**/AppIntegration/**"
          - "**/TerminalService.swift"
          - "**/TerminalIntegration.swift"
          - "**/DisplayProfileManager.swift"
          - "**/DisplayService.swift"
          - "**/DisplayModels.swift"
          - "**/MLXModelManager.swift"
          - "**/ScreenshotPreview.swift"
          - "**/LocalModelsView.swift"
          - "**/LocalModelsSettingsView.swift"
          - "**/FolderAccessManager.swift"
          - "**/RemoteScreenService.swift"
          - "**/RemoteInputService.swift"
          - "**/RemoteSystemService.swift"
          - "**/Resources/Info.plist"
      - path: iOS
      - path: Shared/Resources/Assets.xcassets
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios
        PRODUCT_NAME: Thea
        PRODUCT_MODULE_NAME: TheaCore
        INFOPLIST_FILE: iOS/Info.plist
        CODE_SIGN_ENTITLEMENTS: iOS/Thea.entitlements
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
        TARGETED_DEVICE_FAMILY: "1,2"
        IPHONEOS_DEPLOYMENT_TARGET: "17.0"
        SUPPORTS_MACCATALYST: false

        # Code Signing Identity
        CODE_SIGN_IDENTITY: "iPhone Developer"

        # Runpath Search Paths
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"

      debug:
        CODE_SIGN_IDENTITY: "iPhone Developer"

      release:
        CODE_SIGN_IDENTITY: "iPhone Distribution"
        SWIFT_TREAT_WARNINGS_AS_ERRORS: YES

    dependencies:
      - package: OpenAI
      - package: KeychainAccess
      - package: MarkdownUI
      - package: Highlightr
      - target: TheaShareExtension
        embed: true
        codeSign: true
      - target: TheaWidgetExtension
        embed: true
        codeSign: true
      - target: TheaKeyboardExtension
        embed: true
        codeSign: true
      - target: TheaNotificationServiceExtension
        embed: true
        codeSign: true
      - target: TheaSafariExtension
        embed: true
        codeSign: true
      - target: TheaFocusFilterExtension
        embed: true
        codeSign: true
      - target: TheaCredentialsExtension
        embed: true
        codeSign: true
      - target: TheaIntentsExtension
        embed: true
        codeSign: true

  # ============ watchOS App ============
  Thea-watchOS:
    type: application
    platform: watchOS
    deploymentTarget: "10.0"
    sources:
      - path: watchOS
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.watchos
        PRODUCT_NAME: "Thea Watch"
        PRODUCT_MODULE_NAME: TheaWatch
        INFOPLIST_FILE: watchOS/Info.plist
        CODE_SIGN_ENTITLEMENTS: watchOS/Thea.entitlements
        ASSETCATALOG_COMPILER_APPICON_NAME: ""
        WATCHOS_DEPLOYMENT_TARGET: "10.0"
        TARGETED_DEVICE_FAMILY: 4
        SKIP_INSTALL: NO

        # Code Signing Identity
        CODE_SIGN_IDENTITY: "iPhone Developer"

        # Runpath Search Paths
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"

      release:
        CODE_SIGN_IDENTITY: "iPhone Distribution"
        SWIFT_TREAT_WARNINGS_AS_ERRORS: YES

    dependencies:
      - package: KeychainAccess

  # ============ tvOS App ============
  Thea-tvOS:
    type: application
    platform: tvOS
    deploymentTarget: "17.0"
    sources:
      - path: tvOS
        excludes:
          - "**/TVFeatures/**"
      - path: Shared/Resources/Assets.xcassets
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.tvos
        PRODUCT_NAME: "Thea TV"
        PRODUCT_MODULE_NAME: TheaTV
        INFOPLIST_FILE: tvOS/Info.plist
        CODE_SIGN_ENTITLEMENTS: tvOS/Thea.entitlements
        ASSETCATALOG_COMPILER_APPICON_NAME: ""
        TVOS_DEPLOYMENT_TARGET: "17.0"
        TARGETED_DEVICE_FAMILY: 3

        # Code Signing Identity
        CODE_SIGN_IDENTITY: "iPhone Developer"

        # Runpath Search Paths
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"

      release:
        CODE_SIGN_IDENTITY: "iPhone Distribution"
        SWIFT_TREAT_WARNINGS_AS_ERRORS: YES

    dependencies:
      - package: OpenAI
      - package: KeychainAccess
      - package: MarkdownUI

  # ============================================
  # iOS Extensions
  # ============================================

  # ============ Share Extension (iOS) ============
  TheaShareExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/ShareExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.share
        PRODUCT_NAME: "Share to Thea"
        INFOPLIST_FILE: Extensions/ShareExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/ShareExtension/ShareExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Widget Extension (iOS) ============
  TheaWidgetExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/WidgetExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.widgets
        PRODUCT_NAME: "Thea Widgets"
        INFOPLIST_FILE: Extensions/WidgetExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/WidgetExtension/WidgetExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Keyboard Extension (iOS) ============
  TheaKeyboardExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/KeyboardExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.keyboard
        PRODUCT_NAME: "Thea Keyboard"
        INFOPLIST_FILE: Extensions/KeyboardExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/KeyboardExtension/KeyboardExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Notification Service Extension (iOS) ============
  TheaNotificationServiceExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/NotificationServiceExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.notifications
        PRODUCT_NAME: "Thea Notifications"
        INFOPLIST_FILE: Extensions/NotificationServiceExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/NotificationServiceExtension/NotificationServiceExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============================================
  # macOS Extensions
  # ============================================

  # ============ Finder Sync Extension (macOS) ============
  TheaFinderSyncExtension:
    type: app-extension
    platform: macOS
    deploymentTarget: "14.0"
    sources:
      - path: Extensions/FinderSyncExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.macos.finder
        PRODUCT_NAME: "Thea Finder"
        INFOPLIST_FILE: Extensions/FinderSyncExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/FinderSyncExtension/FinderSyncExtension.entitlements
        SKIP_INSTALL: YES
        ENABLE_HARDENED_RUNTIME: YES
        ENABLE_APP_SANDBOX: YES
        REGISTER_APP_GROUPS: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/../Frameworks"
          - "@executable_path/../../../../Frameworks"

  # ============ Quick Look Extension (macOS) ============
  TheaQuickLookExtension:
    type: app-extension
    platform: macOS
    deploymentTarget: "14.0"
    sources:
      - path: Extensions/QuickLookExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.macos.quicklook
        PRODUCT_NAME: "Thea Quick Look"
        INFOPLIST_FILE: Extensions/QuickLookExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/QuickLookExtension/QuickLookExtension.entitlements
        SKIP_INSTALL: YES
        ENABLE_HARDENED_RUNTIME: YES
        ENABLE_APP_SANDBOX: YES
        REGISTER_APP_GROUPS: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/../Frameworks"
          - "@executable_path/../../../../Frameworks"

  # ============ Safari Extension (macOS) ============
  TheaSafariExtensionMac:
    type: app-extension
    platform: macOS
    deploymentTarget: "14.0"
    sources:
      - path: Extensions/SafariExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.macos.safari
        PRODUCT_NAME: "Thea Safari"
        INFOPLIST_FILE: Extensions/SafariExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/SafariExtension/SafariExtension.entitlements
        SKIP_INSTALL: YES
        ENABLE_HARDENED_RUNTIME: YES
        ENABLE_APP_SANDBOX: YES
        REGISTER_APP_GROUPS: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/../Frameworks"
          - "@executable_path/../../../../Frameworks"

  # ============================================
  # Additional iOS Extensions
  # ============================================

  # ============ Safari Extension (iOS) ============
  TheaSafariExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/SafariExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.safari
        PRODUCT_NAME: "Thea Safari"
        INFOPLIST_FILE: Extensions/SafariExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/SafariExtension/SafariExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Focus Filter Extension (iOS) ============
  TheaFocusFilterExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/FocusFilterExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.focusfilter
        PRODUCT_NAME: "Thea Focus"
        INFOPLIST_FILE: Extensions/FocusFilterExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/FocusFilterExtension/FocusFilterExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Credentials Extension (iOS) ============
  TheaCredentialsExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/CredentialsExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.credentials
        PRODUCT_NAME: "Thea Credentials"
        INFOPLIST_FILE: Extensions/CredentialsExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/CredentialsExtension/CredentialsExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Intents Extension (iOS) ============
  TheaIntentsExtension:
    type: app-extension
    platform: iOS
    deploymentTarget: "17.0"
    sources:
      - path: Extensions/IntentsExtension
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.ios.intents
        PRODUCT_NAME: "Thea Intents"
        INFOPLIST_FILE: Extensions/IntentsExtension/Info.plist
        CODE_SIGN_ENTITLEMENTS: Extensions/IntentsExtension/IntentsExtension.entitlements
        SKIP_INSTALL: YES
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/Frameworks"
          - "@executable_path/../../Frameworks"

  # ============ Tests ============
  TheaTests:
    type: bundle.unit-test
    platform: macOS
    deploymentTarget: "14.0"
    sources:
      - path: Tests
    settings:
      base:
        PRODUCT_BUNDLE_IDENTIFIER: app.thea.tests
        INFOPLIST_FILE: Tests/Info.plist
        TEST_HOST: "$(BUILT_PRODUCTS_DIR)/Thea.app/Contents/MacOS/Thea"
        BUNDLE_LOADER: "$(TEST_HOST)"
        MACOSX_DEPLOYMENT_TARGET: "14.0"
        COMBINE_HIDPI_IMAGES: YES

        # Runpath Search Paths
        LD_RUNPATH_SEARCH_PATHS:
          - "$(inherited)"
          - "@executable_path/../Frameworks"
          - "@loader_path/../Frameworks"

    dependencies:
      - target: Thea-macOS
      - package: OpenAI
      - package: KeychainAccess

# ============================================
# Schemes
# ============================================
schemes:
  Thea-macOS:
    build:
      targets:
        Thea-macOS: all
      parallelizeBuild: true
      buildImplicitDependencies: true
    run:
      config: Debug
      commandLineArguments:
        "-com.apple.CoreData.ConcurrencyDebug": true
      environmentVariables:
        - variable: SQLITE_ENABLE_THREAD_ASSERTIONS
          value: "1"
          isEnabled: true
    test:
      config: Debug
      gatherCoverageData: true
      coverageTargets:
        - Thea-macOS
      targets:
        - name: TheaTests
          parallelizable: true
          randomExecutionOrder: true
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
      revealArchiveInOrganizer: true

  Thea-iOS:
    build:
      targets:
        Thea-iOS: all
      parallelizeBuild: true
      buildImplicitDependencies: true
    run:
      config: Debug
      commandLineArguments:
        "-com.apple.CoreData.ConcurrencyDebug": true
    test:
      config: Debug
      gatherCoverageData: true
      coverageTargets:
        - Thea-iOS
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
      revealArchiveInOrganizer: true

  Thea-watchOS:
    build:
      targets:
        Thea-watchOS: all
      parallelizeBuild: true
      buildImplicitDependencies: true
    run:
      config: Debug
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
      revealArchiveInOrganizer: true

  Thea-tvOS:
    build:
      targets:
        Thea-tvOS: all
      parallelizeBuild: true
      buildImplicitDependencies: true
    run:
      config: Debug
    test:
      config: Debug
      gatherCoverageData: true
      coverageTargets:
        - Thea-tvOS
    profile:
      config: Release
    analyze:
      config: Debug
    archive:
      config: Release
      revealArchiveInOrganizer: true
