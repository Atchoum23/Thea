#!/bin/bash
# Pre-commit hook - catches errors before committing
# Installation: cp Scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "üîç Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get list of staged Swift files
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".swift$")

if [ -z "$SWIFT_FILES" ]; then
    echo -e "${GREEN}‚úÖ No Swift files to check${NC}"
    exit 0
fi

echo "Checking $(echo "$SWIFT_FILES" | wc -l | xargs) Swift files..."

# Type check staged files
ERROR_COUNT=0
WARNING_COUNT=0

for file in $SWIFT_FILES; do
    if [ -f "$file" ]; then
        OUTPUT=$(swiftc -typecheck \
            -continue-building-after-errors \
            -sdk "$(xcrun --show-sdk-path)" \
            "$file" 2>&1 || true)
        
        if echo "$OUTPUT" | grep -q "error:"; then
            echo -e "${RED}‚ùå Errors in $file:${NC}"
            echo "$OUTPUT" | grep "error:"
            ERROR_COUNT=$((ERROR_COUNT + 1))
        fi
        
        if echo "$OUTPUT" | grep -q "warning:"; then
            WARNING_COUNT=$((WARNING_COUNT + 1))
        fi
    fi
done

# Check SwiftLint if available
if command -v swiftlint >/dev/null 2>&1; then
    echo ""
    echo "Running SwiftLint..."
    
    for file in $SWIFT_FILES; do
        swiftlint lint --path "$file" --quiet
    done
fi

# Summary
echo ""
if [ $ERROR_COUNT -gt 0 ]; then
    echo -e "${RED}‚ùå Found errors in $ERROR_COUNT file(s)${NC}"
    echo -e "${YELLOW}Fix errors before committing, or use 'git commit --no-verify' to bypass${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ All checks passed!${NC}"
    if [ $WARNING_COUNT -gt 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Note: $WARNING_COUNT file(s) have warnings${NC}"
    fi
    exit 0
fi
