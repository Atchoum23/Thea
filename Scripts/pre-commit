#!/bin/bash

################################################################################
# Git Pre-Commit Hook
# Validates code quality before allowing commits
# Install: cp Scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
################################################################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Running pre-commit checks...${NC}"

# Get project root
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# Check if SwiftLint is installed
if ! command -v swiftlint &> /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  SwiftLint not found. Install with: brew install swiftlint${NC}"
    echo -e "${YELLOW}Skipping SwiftLint checks...${NC}"
    exit 0
fi

# Get list of staged Swift files
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=d | grep ".swift$" || true)

if [ -z "$SWIFT_FILES" ]; then
    echo -e "${GREEN}‚úÖ No Swift files to check${NC}"
    exit 0
fi

# Run SwiftLint on staged files
echo -e "${BLUE}Checking ${NC}$(echo "$SWIFT_FILES" | wc -l | tr -d ' ')${BLUE} Swift files...${NC}"

if echo "$SWIFT_FILES" | xargs swiftlint lint --quiet --force-exclude; then
    echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
    exit 0
else
    echo -e "${RED}‚ùå SwiftLint found issues in staged files${NC}"
    echo -e "${YELLOW}Fix the issues or use 'git commit --no-verify' to skip checks${NC}"
    exit 1
fi
