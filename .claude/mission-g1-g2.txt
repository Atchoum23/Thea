# THEA G1 + G2 TESTING, VERIFICATION AND FIX MISSION
# ══════════════════════════════════════════════════════════════════════════════
# ⚠️  ABSOLUTE NON-NEGOTIABLE RULE — READ BEFORE DOING ANYTHING
# ══════════════════════════════════════════════════════════════════════════════
# NEVER REMOVE, DELETE, DISABLE, OR REDUCE any existing feature, component,
# class, function, view, capability, or implementation. Wire in, never remove.
# ══════════════════════════════════════════════════════════════════════════════
#
# G1: Live Screen Monitoring + Interactive Voice Guidance (macOS only)
# G2: Automatic Foreground App Pairing (macOS only)
# H Phase: Comprehensive Deep Audit (begins after G1+G2 verified)
#
# Reference files:
#   .claude/G1_TESTING_GUIDE.md       — 10 testing phases
#   .claude/G1_IMPLEMENTATION_SUMMARY.md
#   .claude/G1_FINAL_STATUS.md
#   .claude/G2_TESTING_GUIDE.md       — 11 testing phases
#   .claude/g2-automated-test.sh

## MANDATORY: Read ALL reference files first
```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
cat .claude/G1_TESTING_GUIDE.md
cat .claude/G1_IMPLEMENTATION_SUMMARY.md
cat .claude/G1_FINAL_STATUS.md
cat .claude/G2_TESTING_GUIDE.md
```

## PHASE 1: Verify G1 Files Still Exist and Are Complete

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
ls -la Shared/System/ScreenCapture/
ls -la Shared/System/Input/
ls -la Shared/AI/LiveGuidance/
ls -la Shared/UI/Views/Settings/LiveGuidanceSettingsView.swift
```

Expected files:
- ScreenCaptureManager.swift (~194 lines)
- PointerTracker.swift (~115 lines)
- ActionExecutor.swift (~273 lines)
- LocalVisionGuidance.swift (~357 lines)
- LiveGuidanceSettingsView.swift (~283 lines)

If any are missing or truncated, restore from git history:
```bash
git log --oneline | grep -i "G1\|live.*guid\|screen.*cap" | head -10
git show <commit> -- <file> | grep "^+" | sed 's/^+//' > <file>
```

## PHASE 2: Fix G1 Build Issues

G1_FINAL_STATUS.md notes build was BLOCKED by SPM dependency compilation.
Run build and fix ALL errors:
```bash
xcodebuild -project Thea.xcodeproj -scheme Thea-macOS \
  -configuration Debug -destination "platform=macOS" \
  -derivedDataPath /tmp/TheaBuild CODE_SIGNING_ALLOWED=NO \
  build 2>&1 | grep -E "(error:|warning:)" | head -30
```

Fix every error. The G1 code itself was declared correct — likely a Swift concurrency
or import issue in a dependency. Fix it. Commit after each fix.

## PHASE 3: G1 Functional Verification

Run G1 tests:
```bash
swift test --filter G1 2>&1 | tail -20
swift test --filter LiveGuidance 2>&1 | tail -20
```

Verify all 7 G1 success criteria from G1_TESTING_GUIDE.md:
1. Screen capture works (full screen, active window, pointer tracking)
2. Vision analysis works (Qwen2-VL or CoreML fallback)
3. Voice synthesis works (Soprano-80M or system TTS fallback)
4. No Claude API calls during local vision analysis
5. Control handoff works (Thea can click, type, navigate)
6. User can reclaim control at any time
7. End-to-end multi-step task (Apple Developer Portal scenario) works

If Qwen2-VL 7B is not loaded (requires MSM3U 256GB RAM), use CoreML fallback.
Check ~/.cache/huggingface/hub/ for available models.

## PHASE 4: G2 Verification

G2 = Automatic Foreground App Pairing (context extraction from frontmost app)

Run G2 automated test:
```bash
chmod +x .claude/g2-automated-test.sh
.claude/g2-automated-test.sh 2>&1 | tail -40
```

Or run swift tests:
```bash
swift test --filter AppPairing 2>&1 | tail -20
swift test --filter ContextExtract 2>&1 | tail -20
```

Verify all 15 G2 success criteria from G2_TESTING_GUIDE.md:
1. Settings UI shows app pairing toggle and app list
2. Xcode context extraction (file path, selected text, cursor position)
3. VS Code context extraction
4. Terminal context extraction (last 50 lines, cwd, last command)
5. Notes/TextEdit context extraction
6. Safari context extraction (URL, title, selected text)
7. Generic fallback extractor works for unsupported apps
8. Context injected into AI messages when pairing enabled
9. Context NOT injected when pairing disabled
10. Edge cases handled (no app selected, very long content, special chars)
11. Permission errors handled gracefully
12. Performance: async extraction completes within 2-3s, no UI freezes
13. AI responses are context-aware
14. AppPairingSettingsView wired in MacSettingsView sidebar ✓ (already done)
15. LiveGuidanceSettingsView wired in MacSettingsView sidebar ✓ (just restored)

Fix any failing criteria. Commit after each fix.

## PHASE 5: H Phase — Comprehensive Deep Audit

H Phase = Priority H: Comprehensive Deep Audit of entire Thea codebase.
Reference: .claude/THEA_MASTER_IMPROVEMENT_PLAN.md sections 1-15.

### H Phase 0: Architecture Review
- Read every major service/manager in Shared/
- Verify each has: initialization, real logic, error handling, tests
- Check inter-component communication (notifications, callbacks, delegates)
- Verify no circular dependencies
- Check that all singletons are properly initialized at app startup

### H Phase 1: Intelligence System Audit
- Verify TaskClassifier → ModelRouter → SmartModelRouter pipeline
- Verify ConfidenceSystem runs after every response
- Verify AgentMode phases (gatherContext → takeAction → verifyResults → done)
- Verify AutonomyController approval/rejection flow
- Verify BehavioralFingerprint accumulates real data from usage
- Test PersonalKnowledgeGraph BFS pathfinding

### H Phase 2: Memory System Audit
- Verify conversation history is NEVER truncated (CLAUDE.md mandate)
- Verify SwiftData model containers are correctly configured
- Verify CloudKit sync works (delta sync, subscriptions)
- Test memory retrieval accuracy

### H Phase 3: Integration Systems Audit
- Verify all integrations in Shared/Integrations/ are wired
- HealthKit: all data types reading correctly
- CoreLocation: background + foreground working
- Calendar: read + write working
- Contacts: read working
- Notifications: scheduling working
- AmbientIntelligence: driving detection, activity monitoring wired

### H Phase 4: Security Audit
- Verify OutboundPrivacyGuard intercepts all outbound data
- Verify OpenClawSecurityGuard has all 22 injection patterns
- Verify FunctionGemmaBridge command blocklist
- Verify ConversationLanguageService BCP-47 whitelist (27 languages)
- Run swift test --filter Security

### H Phase 5: Final Integration Test
```bash
swift test 2>&1 | tail -30
xcodebuild -project Thea.xcodeproj -scheme Thea-macOS -configuration Debug \
  -destination "platform=macOS" -derivedDataPath /tmp/TheaBuild \
  CODE_SIGNING_ALLOWED=NO build 2>&1 | grep -E "(error:|warning:)" | wc -l
```
Must be 0 errors, 0 warnings.

## SUCCESS CRITERIA
- G1: All 7 success criteria verified and working
- G2: All 15 success criteria verified and working
- H Phase: All 5 audit phases complete, issues found and fixed
- Build: 0 errors, 0 warnings
- Tests: All pass
