# THEA PERFORMANCE, ENERGY, RESILIENCE, AND LOCALIZATION MISSION
# ══════════════════════════════════════════════════════════════════════════════
# ⚠️  ABSOLUTE NON-NEGOTIABLE RULE — NEVER REMOVE ANYTHING. ONLY ADD AND IMPROVE.
# ══════════════════════════════════════════════════════════════════════════════

## PURPOSE
Make Thea fast, efficient, battery-friendly, offline-resilient, fully localized,
and recoverable from crashes. These dimensions determine daily quality of life.

## PHASE 1: Performance Profiling

### Launch Time
```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
# Build Release macOS
xcodebuild -project Thea.xcodeproj -scheme Thea-macOS -configuration Release \
  -destination "platform=macOS" -derivedDataPath /tmp/TheaBuild \
  CODE_SIGNING_ALLOWED=NO ARCHS=arm64 ONLY_ACTIVE_ARCH=YES build 2>&1 | tail -5

# Measure launch time
/usr/bin/time -l "$(/usr/bin/find /tmp/TheaBuild -name 'Thea' -type f | head -1)" &
sleep 5 && kill %1 2>/dev/null || true
```

Target: cold launch < 3s, warm launch < 1s.

Optimizations to apply:
- Defer non-critical service initialization (use `Task { }` in background)
- Service launch order: UI first, then AI subsystems, then background monitors
- Lazy-initialize expensive services (MLX models should load on-demand, not at startup)
- Avoid synchronous disk I/O on main thread at launch

### Memory Usage
```bash
# Check for retain cycles / memory leaks
leaks --outputFile=/tmp/thea-leaks.txt "Thea" 2>/dev/null || echo "App not running"
```

For each confirmed leak:
- Fix retain cycle (use `[weak self]` in closures, `weak var delegate`)
- Verify fix with another `leaks` run

### CPU Under Load
- During AI inference: verify main thread CPU < 5% (all AI on background actors)
- During ambient monitoring: verify CPU < 2% (use efficient polling via DispatchSource)
- During health kit sync: verify no UI jank (move to background thread)

## PHASE 2: Energy / Battery Impact Audit

```bash
# Check for high-frequency timers
grep -rn "Timer\|DispatchSourceTimer\|repeating" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | \
  grep -v "//\|test\|Test" | head -30

# Check for continuous location use
grep -rn "startUpdatingLocation\|requestLocation\|allowsBackgroundLocationUpdates" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | head -20
```

For each timer:
- Is the frequency appropriate? Polling every 1s drains battery; prefer event-driven
- Use `CLMonitor` for geofencing rather than continuous location updates
- Use `NSBackgroundActivityScheduler` for non-urgent background work
- Throttle ambient monitoring to 5s minimum intervals unless critical

## PHASE 3: Offline Resilience

Thea must degrade gracefully when internet is unavailable:

```bash
grep -rn "URLSession\|URLRequest\|NetworkMonitor\|NWPathMonitor\|isConnected\|reachable" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | head -30
```

For each network call:
- Verify there's a network-unavailable code path
- Show appropriate UI when offline (cached data, "Offline mode" banner)
- AI responses: fall through to local MLX models when cloud unavailable
- Notifications: queue for delivery when connectivity resumes
- Knowledge graph queries: serve from local SwiftData store

Create `Shared/Networking/OfflineResilienceManager.swift` if it doesn't exist:
- Network status monitoring via `NWPathMonitor`
- Request queuing when offline
- Automatic retry when connectivity resumes
- UI publisher for offline state

## PHASE 4: Localization Completeness

Thea declares 27 BCP-47 languages in ConversationLanguageService. But is the UI localized?

```bash
# Check Localizable.strings files
find . -name "Localizable.strings" -not -path "*/.build/*" 2>/dev/null | sort
find . -name "*.xcstrings" -not -path "*/.build/*" 2>/dev/null | sort

# Check for hardcoded English strings in views
grep -rn '"[A-Z][a-z]' --include="*.swift" \
  --exclude-dir=".build" --exclude-dir="MetaAI" . | \
  grep -v "//\|test\|Test\|case \|\".\"\|enum\|struct\|class\|url\|URL\|http" | \
  grep "Text(\|Label(\|\.title\b\|\.message\b" | head -30
```

For macOS/iOS UI:
- Wrap all user-visible strings in `NSLocalizedString("...", comment: "...")`
- Or better: use SwiftUI's `.localizedStringKey`
- Create en.lproj/Localizable.strings for English baseline
- Create fr.lproj (French — common for Alexis given BCP-47 list includes fr)
- Other languages: create stubs that will auto-translate via NSLocalizedString fallback

## PHASE 5: Crash Recovery and Data Integrity

### SwiftData Migration Safety
```bash
# Find SwiftData model versions
grep -rn "VersionedSchema\|SchemaMigrationPlan\|ModelConfiguration" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | head -20
```

Verify:
- If schema has changed, a migration plan exists
- Migration is additive (new optional fields only — never drop columns)
- Test migration by building a clean-schema version

### Keychain Usage
```bash
# Verify API keys are in Keychain, not UserDefaults
grep -rn "UserDefaults.*APIKey\|UserDefaults.*api_key\|UserDefaults.*token\|UserDefaults.*secret" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | head -20

# Find Keychain usage
grep -rn "SecItemAdd\|SecItemCopyMatching\|KeychainService\|KeychainHelper" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | head -20
```

Move any API keys found in UserDefaults to Keychain.

### Crash Recovery Flows
- Verify app shows meaningful error UI (not crash) when:
  - HealthKit authorization denied
  - Location permission denied
  - AI inference OOM (out of memory)
  - Network completely unavailable at launch
  - SwiftData store corrupted (backup + recreate)

## PHASE 6: watchOS Complications

```bash
find . -path "*/watchOS/*" -name "*.swift" -not -path "*/.build/*" 2>/dev/null | sort
```

For watchOS target:
- Verify WidgetKit complications are implemented (health summary, next reminder)
- Verify complications update correctly when data changes
- Verify background refresh works (BGAppRefreshTaskRequest)

## PHASE 7: iCloud Sync Stress Test

```bash
grep -rn "CloudKitService\|CKRecord\|NSUbiquitousKeyValueStore" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | head -20
```

Verify:
- CloudKitService handles CKError.networkUnavailable gracefully
- CloudKitService handles CKError.quotaExceeded gracefully
- NSUbiquitousKeyValueStore changes are propagated within 5s on LAN
- No data loss when sync conflicts occur (last-write-wins or user resolution)

## PHASE 8: Spotlight, Siri, App Intents Audit

```bash
find . -name "*.swift" -not -path "*/.build/*" -not -path "*/MetaAI/*" | \
  xargs grep -l "AppIntent\|Siri\|Spotlight\|CoreSpotlight\|CSSearchableItem" 2>/dev/null | sort
```

Verify:
- All App Intents respond correctly in Shortcuts app
- Spotlight indexes key Thea content (knowledge graph entities, recent conversations)
- AssistantSchema conformance (April 2026 requirement)
- Siri shortcuts work for common actions (ask Thea, start voice session)

## SUCCESS CRITERIA
- Cold launch < 3s, warm launch < 1s
- Memory at rest < 200MB
- No memory leaks from leaks command
- All network calls have offline fallback paths
- API keys stored in Keychain (not UserDefaults)
- English Localizable.strings exists with all user-visible strings
- SwiftData migration plan exists if schema changed
- watchOS complications implemented
- Spotlight indexes Thea content
- 0 build errors, 0 warnings
