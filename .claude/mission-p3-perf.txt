# THEA P3 PERFORMANCE MISSION (runs in parallel with gui-final)
# ══════════════════════════════════════════════════════════════════
# Safe to run concurrently: service-layer only (deferred init, lazy loads).
# Does NOT touch SwiftUI view files. Minimal git conflict risk.
# ══════════════════════════════════════════════════════════════════

## PURPOSE
Complete Item 13 from the P3 Quality mission: Performance Profiling and Optimization.

## NON-NEGOTIABLE RULES
- NEVER remove, replace, or stub any existing functionality
- Only ADD deferred initialization patterns — wrap existing init calls in Task{}
- Only touch service/manager/engine files — NOT SwiftUI views
- Build after each change to confirm no regression
- Commit after every file changed

## TASK

### Step 1: Measure current startup characteristics

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"

# Find all service initializations that might be on the main thread at startup
grep -rn "\.init()\|= .init\|= .*Manager()\|= .*Service()\|= .*Engine()" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" \
  macOS/ iOS/ Shared/ | grep -v "//\|test\|Test\|mock\|Mock" | head -40
```

### Step 2: Check for blocking main-thread work at app init

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"

# Find App lifecycle files
find macOS iOS -name "*App.swift" -o -name "*AppDelegate.swift" 2>/dev/null | head -10

# Check PersonalKnowledgeGraph, BehavioralFingerprint, MLX model loading
grep -rn "PersonalKnowledgeGraph\|BehavioralFingerprint\|MLXAudioEngine\|CoreMLInference" \
  --include="*.swift" --exclude-dir=".build" macOS/ iOS/ Shared/ | \
  grep "= .*init\|\.initialize\|\.load\|\.start" | head -20
```

### Step 3: Defer heavy initializations

For any service initialized synchronously at app start that could be deferred:

BEFORE (blocking):
```swift
let service = HeavyService()
// called at app init
```

AFTER (deferred):
```swift
private var service: HeavyService?
// In .task {} or onAppear:
Task {
    self.service = await HeavyService.initialize()
}
```

Only defer services that:
1. Are NOT needed in the first screen the user sees
2. Have no other services depending on them synchronously at startup
3. Can be safely lazy-initialized

### Step 4: Check for memory leak patterns

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
# Find closures that capture self without [weak self]
grep -rn "{ self\.\|{ _ in.*self\." --include="*.swift" \
  --exclude-dir=".build" --exclude-dir="MetaAI" . | \
  grep -v "\[weak self\]\|\[unowned self\]\|// " | head -30
```

For each closure that captures `self` strongly in a long-lived context (NotificationCenter, Timer, Task stored in a property), add `[weak self]`:
```swift
// Before
somePublisher.sink { value in
    self.handle(value)
}
// After
somePublisher.sink { [weak self] value in
    self?.handle(value)
}
```

### Step 5: Check MLX model memory management

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
grep -rn "MLXAudioEngine\|MLXVisionEngine\|CoreMLInferenceEngine" \
  --include="*.swift" --exclude-dir=".build" . | \
  grep -v "//\|test" | head -20
```

Verify each engine:
- Is loaded lazily (not at app start)
- Has a `deinit` or `unload()` path when not in use
- Responds to `DidReceiveMemoryWarning` / memory pressure notifications

### Step 6: Build and test

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
swift test 2>&1 | tail -5
xcodebuild -project Thea.xcodeproj -scheme Thea-macOS -configuration Debug \
  -destination "platform=macOS" -derivedDataPath /tmp/TheaBuildPerf \
  CODE_SIGNING_ALLOWED=NO ARCHS=arm64 build 2>&1 | grep "BUILD\|error:" | tail -5
```

### Step 7: Commit

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
git add -A && git commit -m "Auto-save: Defer heavy service initializations for faster startup"
```

## SUCCESS CRITERIA
- No heavy service initializations blocking the main thread at app start
- All long-lived closures that reference self use [weak self]
- MLX engines loaded lazily with memory pressure handling
- swift test: 4063 tests passing
- macOS Debug build: BUILD SUCCEEDED
