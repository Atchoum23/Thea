# THEA P2 CODE HEALTH MISSION
# ══════════════════════════════════════════════════════════════════════════════
# ⚠️  ABSOLUTE NON-NEGOTIABLE RULE — NEVER REMOVE ANYTHING. ONLY ADD AND IMPROVE.
# ══════════════════════════════════════════════════════════════════════════════

## PURPOSE
Complete all Priority 2 (HIGH — Code Health) items from THEA_MASTER_IMPROVEMENT_PLAN.md.
These are items 6-10: MetaAI dead code review, @unchecked Sendable audit,
Periphery dead code detection, test coverage to 60%, Maestro E2E fixes.

## ITEM 6: MetaAI Dead Code Review

The MetaAI folder (~73 files) is excluded from all build targets due to type conflicts.
DO NOT move files blindly — conflicts must be resolved first.

```bash
cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
ls AI/MetaAI/ | head -20
# For each file: does it contain unique capability not in Shared/?
# If yes: resolve type conflicts and wire it into Shared/
# If no: leave it (excluded but preserved — NEVER delete)
```

Specifically check:
- `AI/MetaAI/SelfExecution/` — phase orchestration files: do they wire into AgentMode?
- `AI/MetaAI/ModelBenchmarkService.swift` — excluded individually; could be merged into SmartModelRouter

## ITEM 7: @unchecked Sendable Complete Audit

```bash
grep -rn "@unchecked Sendable" \
  --include="*.swift" --exclude-dir=".build" --exclude-dir="MetaAI" . | \
  grep -v "// @unchecked Sendable:" | sort
```

For each occurrence WITHOUT a justification comment, add one:
```swift
// @unchecked Sendable: NSObject delegate, completion called on main thread only
// @unchecked Sendable: AVSpeechSynthesizerDelegate, internal state only set during init
```

If the usage is genuinely unsafe: replace with `actor` isolation or proper `Sendable` conformance.
Target: every @unchecked Sendable has a comment explaining why it's safe.

## ITEM 8: Periphery Dead Code Detection

```bash
# Install if needed
which periphery || brew install periphery

cd "/Users/alexis/Documents/IT & Tech/MyApps/Thea"
periphery scan --project Thea.xcodeproj --schemes Thea-macOS --targets Thea-macOS \
  --format xcode 2>&1 | grep "warning:" | grep -v "MetaAI\|\.build\|\.v1-archive" | head -40
```

For EVERY reported unused declaration:
- Search for callers: `grep -rn "TypeName\|methodName" --include="*.swift"`
- If truly unused: WIRE IT IN — find where it logically belongs and call it
- Never delete — add `// TODO: wire into [subsystem]` comment if wiring requires major work

## ITEM 9: Test Coverage to 60%

```bash
swift test --enable-code-coverage 2>&1 | grep "Test run\|passed\|failed" | tail -5
```

Target services needing coverage (add init + happy path + error path tests for each):
- `SystemCapabilityService` — RAM introspection
- `SmartModelRouter` — model selection logic
- `HealthCoachingPipeline` — insight generation
- `SmartNotificationScheduler` — optimal timing
- `BehavioralFingerprint` — pattern recording and retrieval
- `PersonalKnowledgeGraph` — entity storage and BFS pathfinding
- `AutonomyController` — risk level assessment
- `ConfidenceSystem` — verifier orchestration

Add tests to the appropriate test targets (TheaServicesTests, TheaModelsTests).
Run `swift test` after each batch. All 3800+ existing tests must continue passing.

## ITEM 10: Maestro E2E Tests

The E2E workflow uses Maestro. Verify the test flow files exist and are correct:
```bash
find . -name "*.yaml" -path "*/maestro/*" -o -name "*.yaml" -path "*e2e*" \
  -not -path "*/.build/*" 2>/dev/null | sort
find . -name "*.yaml" -path "*flow*" -not -path "*/.build/*" 2>/dev/null | sort
```

For each Maestro flow:
- Verify the app element IDs match current SwiftUI `.accessibilityIdentifier()` values
- Add missing flows for: new chat, send message, open settings, switch model
- Verify the flow can run against the simulator build from e2e-tests.yml

## ITEM 11: Schema Migration — Wire TheaSchemaMigrationPlan

CRITICAL: `TheamacOSApp.swift` currently deletes the database on schema changes
instead of migrating. This will cause data loss once Thea is in daily use.

Fix: Replace `deleteStoreIfSchemaOutdated()` with proper migration:

```swift
// BEFORE (in TheamacOSApp.init):
Self.deleteStoreIfSchemaOutdated()
let container = try ModelContainer(for: schema, configurations: [config])

// AFTER:
let container = try ModelContainer(
    for: Schema([...]),
    migrationPlan: TheaSchemaMigrationPlan.self,
    configurations: [config]
)
// Remove deleteStoreIfSchemaOutdated() entirely
```

`TheaSchemaMigrationPlan` already exists in `Shared/Core/DataModel/SchemaVersions.swift`
with `SchemaV1` defined. Just wire it in. SwiftData will handle lightweight migrations
automatically when new optional fields are added.

```bash
# Verify fix builds
xcodebuild -project Thea.xcodeproj -scheme Thea-macOS \
  -destination "platform=macOS" -derivedDataPath /tmp/TheaBuild \
  CODE_SIGNING_ALLOWED=NO build 2>&1 | grep "error:\|BUILD" | tail -5
```

## SUCCESS CRITERIA
- Every @unchecked Sendable has a justification comment
- Periphery findings reviewed: all either wired in or commented
- swift test passes with 3800+ tests, coverage visibly increased
- Maestro flows exist and reference correct accessibility IDs  
- TheaSchemaMigrationPlan is wired into ModelContainer (no more deleteStoreIfSchemaOutdated)
- 0 build errors, 0 warnings
