You are fixing all 6 GitHub Actions workflows in .github/workflows/ for the Thea project.
A thorough audit identified 42 issues across P0/P1/P2 priorities. Fix ALL of them.

CRITICAL RULES:
- Read each file fully before editing
- Commit after each workflow file is fixed
- After all 6 are done, run: git pushsync
- Do NOT delete any functionality — fix and improve

═══════════════════════════════════════════════════════════════════
1. ci.yml — CI/CD Pipeline
═══════════════════════════════════════════════════════════════════

P0 fixes:
1a. SwiftLint exit code 2: Find `exit 0` where swiftlint exits with code 2 and remove it.
    Treat exit code 2 as a real failure. Add `::error::` annotation.
1b. test job has NO DerivedData cache. Copy the exact `Cache DerivedData` and `Cache SPM`
    steps from the `build` job into the `test` job (before the test step).
1c. SPM cache path is wrong: The build uses `-derivedDataPath build` so SourcePackages
    live at `build/SourcePackages` — NOT `~/Library/Developer/Xcode/DerivedData/**/SourcePackages`.
    Unify all SPM cache paths to `build/SourcePackages`.

P1 fixes:
1d. Add `permissions: read-all` at the top level of the workflow (outside jobs).
    Then for jobs that need write access (codecov, sonarcloud, quality-gate), add
    targeted `permissions:` blocks per-job.
1e. DerivedData cache key is too broad (`hashFiles('**/*.swift')`). Change to:
    key: ${{ runner.os }}-${{ matrix.scheme }}-deriveddata-${{ hashFiles('project.yml', 'Package.resolved') }}
1f. `workflow_dispatch` input `configuration` is only used in `build` job. Pass it to
    the `test` job as well: replace hardcoded `Debug` in test job with
    `${{ inputs.configuration || 'Debug' }}`
1g. `sonarcloud` job has `continue-on-error: true` — change to `continue-on-error: false`
    and add a TODO comment: "# TODO: Remove continue-on-error once SonarCloud Automatic Analysis is disabled in project settings"

P2 fixes:
1h. Add `paths-ignore` to the push trigger to skip markdown and docs:
    ```
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/*.md'
    ```
1i. `swift package resolve` silences failures with `|| { echo "::warning::..." }`.
    Change to let it fail fast: remove the `|| {` catch block, just `swift package resolve`.
1j. Add code coverage threshold check after the coverage export step:
    After `xcrun xccov view --report --json`, add a step that parses the JSON
    and fails if total line coverage is below 40% (minimum acceptable threshold).
    Use python3 to parse: `python3 -c "import json,sys; d=json.load(open('coverage.json')); cov=d['lineCoverage']; print(f'Coverage: {cov:.1%}'); sys.exit(0 if cov >= 0.40 else 1)"`

═══════════════════════════════════════════════════════════════════
2. e2e-tests.yml — E2E Tests
═══════════════════════════════════════════════════════════════════

P0 fixes:
2a. Maestro pipe swallows exit code. Find the Maestro run step that pipes through `tee`.
    Change from:
      maestro test ... 2>&1 | tee maestro-results.log
      echo "exit_code=$?" >> $GITHUB_OUTPUT
    To:
      maestro test ... 2>&1 | tee maestro-results.log
      MAESTRO_EXIT=${PIPESTATUS[0]}
      echo "exit_code=$MAESTRO_EXIT" >> $GITHUB_OUTPUT
    And where the exit code is checked, use the captured variable.
2b. Maestro version pinning: Find the install step with `curl .../get.maestro.mobile.dev | bash`.
    Change to pin the version:
      curl -Ls "https://get.maestro.mobile.dev?version=1.38.1" | bash
    Keep the cache key as `maestro-1.38.1` — now it's consistent.

P1 fixes:
2c. Concurrency key for nightly: Change the concurrency group from:
      group: ${{ github.workflow }}-${{ github.ref }}
    To:
      group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
    This prevents pushes from cancelling nightly scheduled runs.
2d. Add DerivedData caching to E2E workflow. After the checkout step, add:
    ```yaml
    - name: Cache DerivedData
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: ${{ runner.temp }}/TheaBuild
        key: ${{ runner.os }}-e2e-deriveddata-${{ hashFiles('project.yml', 'Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-e2e-deriveddata-
    ```
2e. Simulator selection is fragile (uses `grep "iPhone" | head -1`). Replace with:
    ```bash
    # Try iPhone 16 first, then 15, then any iPhone as fallback
    SIM_UDID=$(xcrun simctl list devices available --json | python3 -c "
    import json,sys
    devices=json.load(sys.stdin)['devices']
    for runtime,devs in sorted(devices.items(), reverse=True):
      if 'iOS' not in runtime: continue
      for d in devs:
        if 'iPhone 16' in d['name']:
          print(d['udid']); sys.exit(0)
    for runtime,devs in sorted(devices.items(), reverse=True):
      if 'iOS' not in runtime: continue
      for d in devs:
        if 'iPhone 15' in d['name']:
          print(d['udid']); sys.exit(0)
    for runtime,devs in sorted(devices.items(), reverse=True):
      if 'iOS' not in runtime: continue
      for d in devs:
        if 'iPhone' in d['name']:
          print(d['udid']); sys.exit(0)
    sys.exit(1)
    ") || { echo '::error::No iPhone simulator found'; exit 1; }
    ```
2f. Add screenshot/artifact capture on failure. After the Maestro test step, add:
    ```yaml
    - name: Upload Maestro Artifacts on Failure
      if: failure()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: maestro-failure-${{ github.sha }}
        path: |
          ~/.maestro/tests/
          maestro-results.log
        retention-days: 14
        if-no-files-found: ignore
    ```
2g. E2E runs on every PR — too expensive. Change the pull_request trigger to only run
    when the PR has the 'e2e' label:
    ```yaml
    pull_request:
      branches: [main, develop]
      types: [labeled]
    ```
    And add a job condition: `if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'e2e')`

P2 fixes:
2h. Increase timeout from 60 to 90 minutes: `timeout-minutes: 90`
2i. Add comment on `ENABLE_DEBUG_DYLIB=NO`:
    `# TODO FB12345678: Xcode 26 debug dylib workaround — revisit when Xcode is updated`

═══════════════════════════════════════════════════════════════════
3. release.yml — Release
═══════════════════════════════════════════════════════════════════

P0 fixes:
3a. Add CI gate before release. Add a new job BEFORE build-release:
    ```yaml
    validate-ci:
      name: Validate CI Passed
      runs-on: ubuntu-latest
      steps:
        - name: Check CI workflow status
          uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
          with:
            script: |
              const ref = context.sha;
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: 'main',
                status: 'success',
                per_page: 10,
              });
              const ciRun = runs.workflow_runs.find(r => r.name === 'CI' && r.head_sha === ref);
              if (!ciRun) {
                core.setFailed('No successful CI run found for this commit. Release blocked.');
              } else {
                console.log('CI passed:', ciRun.html_url);
              }
    ```
    Then add `needs: validate-ci` to the `build-release` job.

3b. Add version format validation. In the `Extract Version` step, after VERSION is set, add:
    ```bash
    # Validate semver format
    if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
      echo "::error::Invalid version format: '$VERSION'. Must be semver (e.g. 1.2.3 or 1.2.3-beta.1)"
      exit 1
    fi
    echo "Version validated: $VERSION"
    ```

3c. Code signing: The current `CODE_SIGNING_REQUIRED=NO` produces unusable artifacts.
    Add a note at the top of the file and add a step that documents the required secrets:
    ```yaml
    # ⚠️ CODE SIGNING NOTE:
    # For real distribution, the following GitHub Secrets must be configured:
    #   APPLE_CERTIFICATE_BASE64    - p12 certificate exported from Keychain, base64 encoded
    #   APPLE_CERTIFICATE_PASSWORD  - p12 password
    #   KEYCHAIN_PASSWORD           - temporary keychain password for CI
    #   APPLE_TEAM_ID               - your Apple Developer Team ID
    # Until those are configured, builds use CODE_SIGNING_ALLOWED=NO (CI validation only)
    # The resulting artifacts are NOT suitable for distribution to end users.
    ```
    Also add a step to import the certificate when it's available:
    ```yaml
    - name: Import Code Signing Certificate
      if: secrets.APPLE_CERTIFICATE_BASE64 != ''
      env:
        CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        echo "$CERTIFICATE_BASE64" | base64 --decode > /tmp/cert.p12
        security import /tmp/cert.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"
        echo "CODE_SIGN_IDENTITY=Apple Development" >> $GITHUB_ENV
    ```

P1 fixes:
3d. Auto-generate release notes from git log. Replace the hardcoded `cat > release-notes.md << EOF` block with:
    ```bash
    VERSION="${{ steps.version.outputs.version }}"
    PREV_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")
    echo "## Thea v${VERSION}" > release-notes.md
    echo "" >> release-notes.md
    if [ -n "$PREV_TAG" ]; then
      echo "### Changes since ${PREV_TAG}" >> release-notes.md
      git log --pretty=format:"- %s" "${PREV_TAG}..HEAD" | grep -v "^- Auto-save:" | head -50 >> release-notes.md
    fi
    echo "" >> release-notes.md
    echo "### Platforms" >> release-notes.md
    echo "- macOS 26.0+, iOS 26.0+, watchOS 26.0+, tvOS 26.0+" >> release-notes.md
    echo "" >> release-notes.md
    echo "*Built with Swift 6.0, zero warnings, zero errors*" >> release-notes.md
    ```
3e. In `create-release`, also download watchOS and tvOS artifacts:
    Add two more `Download Artifact` steps for `thea-watchOS-*` and `thea-tvOS-*`.
    Label them as "developer build" in release body.
3f. Add `permissions: read-all` at workflow top level.

P2 fixes:
3g. Add SBOM generation. In the `create-release` job, after downloading artifacts:
    ```yaml
    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        format: spdx-json
        output-file: thea-${{ needs.build-release.outputs.version }}-sbom.spdx.json
    - name: Upload SBOM to Release
      # Upload the SBOM file alongside the release artifacts
      run: echo "SBOM generated"
    ```

═══════════════════════════════════════════════════════════════════
4. security.yml — Security Scanning
═══════════════════════════════════════════════════════════════════

P0 fixes:
4a. Replace the fake dependency-audit job with real CVE scanning using osv-scanner.
    Replace the entire `dependency-audit` job with:
    ```yaml
    dependency-audit:
      name: CVE Scanning (osv-scanner)
      runs-on: ubuntu-latest
      timeout-minutes: 10
      permissions:
        security-events: write
        contents: read
      steps:
        - name: Checkout
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

        - name: Run OSV Scanner
          uses: google/osv-scanner-action@v2
          with:
            scan-args: |-
              --output=results.json
              --format=json
              ./
          continue-on-error: true

        - name: Upload OSV Results
          if: always()
          uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
          with:
            name: osv-scan-results-${{ github.sha }}
            path: results.json
            retention-days: 30

        - name: Upload SARIF to GitHub Security
          if: always() && hashFiles('results.json') != ''
          uses: github/codeql-action/upload-sarif@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1
          with:
            sarif_file: results.json
            category: osv-scanner

        - name: Check for Critical Vulnerabilities
          if: always()
          run: |
            if [ -f results.json ]; then
              CRITICAL=$(python3 -c "
              import json, sys
              try:
                d = json.load(open('results.json'))
                vulns = d.get('results', [])
                critical = sum(1 for r in vulns for v in r.get('vulnerabilities', [])
                               if any(s.get('type') == 'CVSS_V3' and float(s.get('score', 0)) >= 9.0
                                      for s in v.get('severity', [])))
                print(critical)
              except: print(0)
              ")
              if [ "$CRITICAL" -gt "0" ]; then
                echo "::error::OSV scanner found $CRITICAL critical CVEs"
                exit 1
              fi
              echo "OSV scan complete — no critical CVEs found"
            fi
    ```

4b. Add `permissions: security-events: write` to the `gitleaks` job.

P1 fixes:
4c. Add `permissions: read-all` at workflow top level.
4d. Change concurrency group for scheduled runs:
    ```yaml
    concurrency:
      group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
      cancel-in-progress: true
    ```
4e. Update `security-summary` to also fail on dependency-audit failure:
    ```yaml
    - name: Fail if critical checks failed
      if: needs.gitleaks.result == 'failure' || needs.dependency-audit.result == 'failure'
      run: |
        echo "::error::Security checks failed"
        exit 1
    ```

P2 fixes:
4f. Add `.gitleaks.toml` config file to the repo root (create it) with sensible allowlist:
    ```toml
    title = "Thea Gitleaks Config"
    [extend]
    useDefault = true
    [[allowlist.rules]]
    id = "test-fixtures"
    description = "Ignore test fixtures and ML model hashes"
    paths = [
      '''Tests/.*''',
      '''.*\.mlmodelc/.*''',
      '''.*Package\.resolved''',
    ]
    [[allowlist.rules]]
    id = "sample-data"
    description = "Ignore sample/example data files"
    regexTarget = "line"
    regexes = ['''example.*key''', '''sample.*token''', '''placeholder''']
    ```
    Then in the gitleaks job step, add: `config-path: .gitleaks.toml`

═══════════════════════════════════════════════════════════════════
5. thea-audit-main.yml — Security Audit (Full)
═══════════════════════════════════════════════════════════════════

P0 fixes:
5a. Remove `|| true` from ALL `$THEA_AUDIT scan` calls so build failures fail the job.
    Also make the `Build thea-audit` step fail hard: remove any error suppression there.
5b. Replace `grep -c` severity counting with python3 JSON parsing:
    ```bash
    CRITICAL_COUNT=$(python3 -c "
    import json, sys
    try:
      d = json.load(open('audit-results.json'))
      findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
      print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'critical'))
    except Exception as e:
      print(0)
    " 2>/dev/null)
    HIGH_COUNT=$(python3 -c "
    import json, sys
    try:
      d = json.load(open('audit-results.json'))
      findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
      print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'high'))
    except: print(0)
    " 2>/dev/null)
    MEDIUM_COUNT=$(python3 -c "
    import json, sys
    try:
      d = json.load(open('audit-results.json'))
      findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
      print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'medium'))
    except: print(0)
    " 2>/dev/null)
    LOW_COUNT=$(python3 -c "
    import json, sys
    try:
      d = json.load(open('audit-results.json'))
      findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
      print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'low'))
    except: print(0)
    " 2>/dev/null)
    ```
5c. Fix the `if:` condition for issue creation:
    Change: `if: steps.audit.outputs.critical_count > 0`
    To: `if: steps.audit.outputs.critical_count != '' && steps.audit.outputs.critical_count > 0`

P1 fixes:
5d. Add `DEVELOPER_DIR` env var or `sudo xcode-select` before building thea-audit:
    Add to the `Build thea-audit` step:
    ```bash
    sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
    ```
5e. Add path filter for the workflow file itself and policy file:
    In the `on.push.paths` array, add:
    - `.github/workflows/thea-audit-main.yml`
    - `thea-policy.json`
5f. Truncate audit report in issue body to avoid 65k limit:
    In the github-script step, add after reading audit-report.md:
    ```javascript
    // Truncate to stay under GitHub's 65,536 char issue body limit
    const MAX_BODY = 60000;
    if (reportContent.length > MAX_BODY) {
      reportContent = reportContent.substring(0, MAX_BODY) + '\n\n... (truncated — see full artifact)';
    }
    ```
5g. Fix concurrency group for scheduled vs push runs:
    `group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}`

═══════════════════════════════════════════════════════════════════
6. thea-audit-pr.yml — Security Audit (PR)
═══════════════════════════════════════════════════════════════════

P0 fixes:
6a. Fix `workflow_dispatch` breaking PR-specific variables.
    Option A (preferred): Remove `workflow_dispatch:` from the `on:` block entirely.
    The full audit is already available via `workflow_dispatch` in `thea-audit-main.yml`.
    PR workflow should only run on PRs.

P1 fixes:
6b. Reduce fetch-depth. Change checkout to:
    ```yaml
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      with:
        fetch-depth: 0  # Needed for delta diff against base branch
        # Note: fetch-depth 0 required because --base-branch needs full history
    ```
    (Keep fetch-depth 0 but document why — the delta audit needs the full base branch)
6c. Fix PR comment bot-match. In the github-script step, change the comment detection from:
    ```javascript
    comment.user.type === 'Bot' && comment.body.includes('Security Audit Results')
    ```
    To:
    ```javascript
    comment.user.type === 'Bot' && comment.body.includes('<!-- thea-audit-pr -->')
    ```
    And add `<!-- thea-audit-pr -->` as the first line of the `summary` string.
6d. Add permissions: read-all at workflow top level.

═══════════════════════════════════════════════════════════════════
COMPOSITE ACTION (P1 #12 — shared setup)
═══════════════════════════════════════════════════════════════════

Create `.github/actions/setup-xcode/action.yml`:
```yaml
name: Setup Xcode and XcodeGen
description: Installs XcodeGen, selects Xcode version, and sets up SPM cache

inputs:
  xcode-version:
    description: Xcode version to use
    required: false
    default: '26.2'
  scheme:
    description: Scheme name (used for cache key scoping)
    required: false
    default: 'all'

runs:
  using: composite
  steps:
    - name: Select Xcode
      shell: bash
      run: sudo xcode-select -s /Applications/Xcode_${{ inputs.xcode-version }}.app/Contents/Developer

    - name: Cache XcodeGen
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: /opt/homebrew/Cellar/xcodegen
        key: ${{ runner.os }}-xcodegen-2.43.0
        restore-keys: ${{ runner.os }}-xcodegen-

    - name: Install XcodeGen
      shell: bash
      run: |
        if ! command -v xcodegen &>/dev/null; then
          brew install xcodegen
        fi
        xcodegen --version

    - name: Generate Xcode Project
      shell: bash
      run: xcodegen generate

    - name: Cache SPM packages
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: build/SourcePackages
        key: ${{ runner.os }}-${{ inputs.scheme }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-${{ inputs.scheme }}-spm-
          ${{ runner.os }}-spm-
```

Then update all 6 workflow files to replace the duplicated setup steps with:
```yaml
- name: Setup Xcode and XcodeGen
  uses: ./.github/actions/setup-xcode
  with:
    xcode-version: '26.2'
    scheme: ${{ matrix.scheme || 'default' }}
```

═══════════════════════════════════════════════════════════════════
VERIFICATION
═══════════════════════════════════════════════════════════════════

After all fixes:
1. Run: yamllint .github/workflows/*.yml 2>/dev/null || python3 -c "import yaml; [yaml.safe_load(open(f)) for f in __import__('glob').glob('.github/workflows/*.yml')]; print('All YAML valid')"
2. Check no workflow references undefined secrets without a fallback
3. git add .github/ && git commit -m "Fix: All 6 GitHub Actions workflows — 42 issues (P0/P1/P2)"
4. git pushsync
