# Thea Security Audit Workflow (PR)
# Version: 2.0.0 - Delta security audit for Pull Requests with strict enforcement
# Last Updated: January 27, 2026

name: Security Audit (PR)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'Shared/**'
      - 'Tests/**'
      - 'Tools/**'
      - 'Scripts/**'
      - 'iOS/**'
      - 'macOS/**'
      - 'watchOS/**'
      - 'tvOS/**'
      - '.github/workflows/**'
      - 'Package.swift'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: Security Audit (Delta)
    runs-on: macos-26
    timeout-minutes: 20
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a # v2.4.0
        with:
          swift-version: "6.0"

      - name: Cache thea-audit Build
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: Tools/thea-audit/.build
          key: ${{ runner.os }}-thea-audit-${{ hashFiles('Tools/thea-audit/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-thea-audit-

      - name: Build thea-audit
        working-directory: Tools/thea-audit
        run: |
          xcrun swift build -c release
          echo "THEA_AUDIT=$(pwd)/.build/release/thea-audit" >> $GITHUB_ENV

      - name: Get Changed Files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.(swift|ts|tsx|yml|yaml|sh)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No relevant files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" > /tmp/changed_files.txt
          fi

      - name: Run Security Audit (Delta Mode)
        if: steps.changed-files.outputs.has_changes == 'true'
        id: audit
        run: |
          # Run delta audit
          $THEA_AUDIT audit \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format yaml \
            --output audit-results.yaml \
            --policy thea-policy.json \
            --strict || true

          AUDIT_EXIT_CODE=$?

          # Generate markdown summary
          $THEA_AUDIT audit \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format markdown \
            --output audit-summary.md \
            --policy thea-policy.json || true

          # Generate JSON for counting
          $THEA_AUDIT audit \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format json \
            --output audit-results.json \
            --policy thea-policy.json || true

          # Count findings
          CRITICAL_COUNT=$(grep -c '"severity": "critical"' audit-results.json 2>/dev/null || echo 0)
          HIGH_COUNT=$(grep -c '"severity": "high"' audit-results.json 2>/dev/null || echo 0)

          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

      - name: Upload Audit Results
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-audit-pr-${{ github.event.pull_request.number }}
          path: |
            audit-results.yaml
            audit-results.json
            audit-summary.md
          retention-days: 30

      - name: Comment on PR
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            const criticalCount = ${{ steps.audit.outputs.critical_count || 0 }};
            const highCount = ${{ steps.audit.outputs.high_count || 0 }};

            let summary = '## Security Audit Results\n\n';

            if (criticalCount > 0 || highCount > 0) {
              summary += `### Findings\n`;
              summary += `- **Critical**: ${criticalCount}\n`;
              summary += `- **High**: ${highCount}\n\n`;
            }

            if (fs.existsSync('audit-summary.md')) {
              const auditSummary = fs.readFileSync('audit-summary.md', 'utf8');
              summary += auditSummary;
            } else if (criticalCount === 0 && highCount === 0) {
              summary += 'No security issues found in changed files.\n';
            }

            summary += '\n---\n';
            summary += '*Generated by [thea-audit](Tools/thea-audit) security scanner*\n';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Security Audit Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Check Audit Status
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          CRITICAL=${{ steps.audit.outputs.critical_count || 0 }}
          HIGH=${{ steps.audit.outputs.high_count || 0 }}

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Security audit found $CRITICAL critical severity issue(s)"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::error::Security audit found $HIGH high severity issue(s)"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi

          echo "Security audit passed"

      - name: Skip Audit (No Relevant Changes)
        if: steps.changed-files.outputs.has_changes != 'true'
        run: |
          echo "No relevant files changed - skipping security audit"
