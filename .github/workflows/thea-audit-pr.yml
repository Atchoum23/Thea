# Thea Security Audit Workflow (PR)
# Version: 2.4.0 - Added workflow_dispatch with base_ref input (allows manual full-codebase
#                  delta scan from GitHub UI, and testing without an open PR)
# Last Updated: February 19, 2026
#
# TRIGGER MODES:
#   pull_request — automatic delta audit on every PR touching source code
#   workflow_dispatch — manual delta audit comparing HEAD against any base branch
#     Use case: scan current main against a previous release, test the audit pipeline,
#               or run a delta scan between feature branches without creating a PR

name: Thea Security Audit (PR)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'Shared/**'
      - 'Tests/**'
      - 'Tools/**'
      - 'Scripts/**'
      - 'iOS/**'
      - 'macOS/**'
      - 'watchOS/**'
      - 'tvOS/**'
      - '.github/workflows/**'
      - 'Package.swift'
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Base branch to compare against (delta audit)'
        required: false
        default: 'main'
        type: string
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'low'
        type: choice
        options: [critical, high, medium, low]

permissions: read-all

concurrency:
  # For PRs: group by PR number. For manual dispatches: group by run_id (no cancellation conflict)
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: Security Audit (Delta)
    runs-on: macos-26
    timeout-minutes: 20
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Resolve Context
        run: |
          # Determine effective base ref and whether this is a PR or manual dispatch.
          # PR context:       use github.base_ref (branch name) and PR SHAs for diff
          # Manual dispatch:  use inputs.base_ref (default: main) and compare HEAD vs remote
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "EFFECTIVE_BASE_REF=${{ github.base_ref }}" >> $GITHUB_ENV
            echo "IS_PR=true" >> $GITHUB_ENV
            echo "MODE=PR #${{ github.event.pull_request.number }}"
          else
            BASE="${{ inputs.base_ref || 'main' }}"
            echo "EFFECTIVE_BASE_REF=$BASE" >> $GITHUB_ENV
            echo "IS_PR=false" >> $GITHUB_ENV
            echo "MODE=manual dispatch against origin/$BASE"
          fi

          # Fork safety: restrict PR comment writes to non-fork PRs only.
          # Fork PRs get read-only GITHUB_TOKEN — they cannot write PR comments.
          # The audit still runs and results are uploaded as artifacts.
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ] \
             && [ "${{ github.event.pull_request.head.repo.full_name }}" != "" ]; then
            echo "::notice::Fork PR detected — PR comment writing will be skipped (read-only token)"
            echo "IS_FORK=true" >> $GITHUB_ENV
          else
            echo "IS_FORK=false" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # fetch-depth 0 required — delta audit needs full history for --base-branch comparison
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a # v2.4.0
        with:
          swift-version: "6.0"

      - name: Cache thea-audit Build
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: Tools/thea-audit/.build
          key: ${{ runner.os }}-thea-audit-${{ hashFiles('Tools/thea-audit/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-thea-audit-

      - name: Build thea-audit
        working-directory: Tools/thea-audit
        run: |
          xcrun swift build -c release
          echo "THEA_AUDIT=$(pwd)/.build/release/thea-audit" >> $GITHUB_ENV

      - name: Get Changed Files
        id: changed-files
        run: |
          # Fetch the base branch so git diff can compare against it
          git fetch origin "$EFFECTIVE_BASE_REF" --depth=100 2>/dev/null || true

          if [ "$IS_PR" = "true" ]; then
            # PR mode: compare PR base SHA vs PR head SHA (exact diff of this PR)
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" \
              | grep -E '\.(swift|ts|tsx|yml|yaml|sh)$' || true)
          else
            # Manual dispatch mode: compare HEAD vs remote base branch
            CHANGED_FILES=$(git diff --name-only "origin/$EFFECTIVE_BASE_REF" HEAD \
              | grep -E '\.(swift|ts|tsx|yml|yaml|sh)$' || true)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No relevant files changed vs origin/$EFFECTIVE_BASE_REF"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" > /tmp/changed_files.txt
          fi

      - name: Run Security Audit (Delta Mode)
        if: steps.changed-files.outputs.has_changes == 'true'
        id: audit
        run: |
          # Run delta audit
          $THEA_AUDIT scan \
            --path . \
            --delta \
            --base-branch "origin/$EFFECTIVE_BASE_REF" \
            --format yaml \
            --output audit-results.yaml \
            --policy thea-policy.json \
            --strict || true

          AUDIT_EXIT_CODE=$?

          # Generate markdown summary
          $THEA_AUDIT scan \
            --path . \
            --delta \
            --base-branch "origin/$EFFECTIVE_BASE_REF" \
            --format markdown \
            --output audit-summary.md \
            --policy thea-policy.json || true

          # Generate JSON for counting
          $THEA_AUDIT scan \
            --path . \
            --delta \
            --base-branch "origin/$EFFECTIVE_BASE_REF" \
            --format json \
            --output audit-results.json \
            --policy thea-policy.json || true

          # Count findings using python3 JSON parsing (robust vs grep -c)
          CRITICAL_COUNT=$(python3 -c "
          import json, sys
          try:
            d = json.load(open('audit-results.json'))
            findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
            print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'critical'))
          except: print(0)
          " 2>/dev/null || echo 0)
          HIGH_COUNT=$(python3 -c "
          import json, sys
          try:
            d = json.load(open('audit-results.json'))
            findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
            print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'high'))
          except: print(0)
          " 2>/dev/null || echo 0)

          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

      - name: Upload Audit Results
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-audit-pr-${{ github.event.pull_request.number || github.run_id }}
          path: |
            audit-results.yaml
            audit-results.json
            audit-summary.md
          retention-days: 30

      - name: Comment on PR
        # Only comment when triggered by a real PR (not manual dispatch) and not a fork
        if: steps.changed-files.outputs.has_changes == 'true' && env.IS_FORK != 'true' && env.IS_PR == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            const criticalCount = ${{ steps.audit.outputs.critical_count || 0 }};
            const highCount = ${{ steps.audit.outputs.high_count || 0 }};

            // Add bot marker for stable comment detection
            let summary = '<!-- thea-audit-pr -->\n';
            summary += '## Security Audit Results\n\n';

            if (criticalCount > 0 || highCount > 0) {
              summary += `### Findings\n`;
              summary += `- **Critical**: ${criticalCount}\n`;
              summary += `- **High**: ${highCount}\n\n`;
            }

            if (fs.existsSync('audit-summary.md')) {
              const auditSummary = fs.readFileSync('audit-summary.md', 'utf8');
              summary += auditSummary;
            } else if (criticalCount === 0 && highCount === 0) {
              summary += 'No security issues found in changed files.\n';
            }

            summary += '\n---\n';
            summary += '*Generated by [thea-audit](Tools/thea-audit) security scanner*\n';

            // Find existing comment using stable bot marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- thea-audit-pr -->')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Check Audit Status
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          CRITICAL=${{ steps.audit.outputs.critical_count || 0 }}
          HIGH=${{ steps.audit.outputs.high_count || 0 }}

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Security audit found $CRITICAL critical severity issue(s)"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::error::Security audit found $HIGH high severity issue(s)"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi

          echo "Security audit passed"

      - name: Skip Audit (No Relevant Changes)
        if: steps.changed-files.outputs.has_changes != 'true'
        run: |
          echo "No relevant files changed - skipping security audit"

      - name: Notify (ntfy)
        if: always() && steps.changed-files.outputs.has_changes == 'true'
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          if [ -z "$NTFY_TOPIC" ]; then exit 0; fi

          CRITICAL="${{ steps.audit.outputs.critical_count || 0 }}"
          HIGH="${{ steps.audit.outputs.high_count || 0 }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if [ "${CRITICAL:-0}" -gt 0 ] || [ "${HIGH:-0}" -gt 0 ]; then
            PRIORITY=5; TAG="rotating_light"
            STATUS="Issues Found"
          else
            PRIORITY=2; TAG="white_check_mark"
            STATUS="Clean"
          fi

          # Determine click URL: PR page for PR events, Actions run for dispatches
          if [ "$IS_PR" = "true" ] && [ -n "$PR_NUM" ]; then
            CLICK_URL="https://github.com/${{ github.repository }}/pull/${PR_NUM}"
            CONTEXT="PR #${PR_NUM}: ${PR_TITLE}"
          else
            CLICK_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            CONTEXT="Manual dispatch vs origin/$EFFECTIVE_BASE_REF"
          fi

          curl -s -o /dev/null \
            -H "Title: Thea Audit (Delta) - $STATUS" \
            -H "Priority: $PRIORITY" \
            -H "Tags: $TAG" \
            -H "Click: $CLICK_URL" \
            -d "Critical: ${CRITICAL:-0} | High: ${HIGH:-0} | ${CONTEXT}" \
            "https://ntfy.sh/$NTFY_TOPIC" || true
