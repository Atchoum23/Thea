# Thea Security Audit Workflow (PR)
# Version: 2.3.0 - Added fork PR safety (write permissions gated to non-forks),
#                  ntfy progress notifications
# Last Updated: February 19, 2026

name: Thea Security Audit (PR)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'Shared/**'
      - 'Tests/**'
      - 'Tools/**'
      - 'Scripts/**'
      - 'iOS/**'
      - 'macOS/**'
      - 'watchOS/**'
      - 'tvOS/**'
      - '.github/workflows/**'
      - 'Package.swift'

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: Security Audit (Delta)
    runs-on: macos-26
    timeout-minutes: 20
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Fork Safety Check
        run: |
          # Restrict PR comment writes to non-fork PRs only.
          # Fork PRs get read-only GITHUB_TOKEN — they cannot write PR comments.
          # The audit still runs and results are uploaded as artifacts.
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "::notice::Fork PR detected — PR comment writing will be skipped (read-only token)"
            echo "IS_FORK=true" >> $GITHUB_ENV
          else
            echo "IS_FORK=false" >> $GITHUB_ENV
          fi

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # fetch-depth 0 required — delta audit needs full history for --base-branch comparison
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a # v2.4.0
        with:
          swift-version: "6.0"

      - name: Cache thea-audit Build
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: Tools/thea-audit/.build
          key: ${{ runner.os }}-thea-audit-${{ hashFiles('Tools/thea-audit/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-thea-audit-

      - name: Build thea-audit
        working-directory: Tools/thea-audit
        run: |
          xcrun swift build -c release
          echo "THEA_AUDIT=$(pwd)/.build/release/thea-audit" >> $GITHUB_ENV

      - name: Get Changed Files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.(swift|ts|tsx|yml|yaml|sh)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No relevant files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" > /tmp/changed_files.txt
          fi

      - name: Run Security Audit (Delta Mode)
        if: steps.changed-files.outputs.has_changes == 'true'
        id: audit
        run: |
          # Run delta audit
          $THEA_AUDIT scan \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format yaml \
            --output audit-results.yaml \
            --policy thea-policy.json \
            --strict || true

          AUDIT_EXIT_CODE=$?

          # Generate markdown summary
          $THEA_AUDIT scan \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format markdown \
            --output audit-summary.md \
            --policy thea-policy.json || true

          # Generate JSON for counting
          $THEA_AUDIT scan \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format json \
            --output audit-results.json \
            --policy thea-policy.json || true

          # Count findings using python3 JSON parsing (robust vs grep -c)
          CRITICAL_COUNT=$(python3 -c "
          import json, sys
          try:
            d = json.load(open('audit-results.json'))
            findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
            print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'critical'))
          except: print(0)
          " 2>/dev/null || echo 0)
          HIGH_COUNT=$(python3 -c "
          import json, sys
          try:
            d = json.load(open('audit-results.json'))
            findings = d if isinstance(d, list) else d.get('findings', d.get('results', []))
            print(sum(1 for f in findings if isinstance(f, dict) and f.get('severity','').lower() == 'high'))
          except: print(0)
          " 2>/dev/null || echo 0)

          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

      - name: Upload Audit Results
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-audit-pr-${{ github.event.pull_request.number }}
          path: |
            audit-results.yaml
            audit-results.json
            audit-summary.md
          retention-days: 30

      - name: Comment on PR
        if: steps.changed-files.outputs.has_changes == 'true' && env.IS_FORK != 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            const criticalCount = ${{ steps.audit.outputs.critical_count || 0 }};
            const highCount = ${{ steps.audit.outputs.high_count || 0 }};

            // Add bot marker for stable comment detection
            let summary = '<!-- thea-audit-pr -->\n';
            summary += '## Security Audit Results\n\n';

            if (criticalCount > 0 || highCount > 0) {
              summary += `### Findings\n`;
              summary += `- **Critical**: ${criticalCount}\n`;
              summary += `- **High**: ${highCount}\n\n`;
            }

            if (fs.existsSync('audit-summary.md')) {
              const auditSummary = fs.readFileSync('audit-summary.md', 'utf8');
              summary += auditSummary;
            } else if (criticalCount === 0 && highCount === 0) {
              summary += 'No security issues found in changed files.\n';
            }

            summary += '\n---\n';
            summary += '*Generated by [thea-audit](Tools/thea-audit) security scanner*\n';

            // Find existing comment using stable bot marker
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('<!-- thea-audit-pr -->')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Check Audit Status
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          CRITICAL=${{ steps.audit.outputs.critical_count || 0 }}
          HIGH=${{ steps.audit.outputs.high_count || 0 }}

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Security audit found $CRITICAL critical severity issue(s)"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::error::Security audit found $HIGH high severity issue(s)"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi

          echo "Security audit passed"

      - name: Skip Audit (No Relevant Changes)
        if: steps.changed-files.outputs.has_changes != 'true'
        run: |
          echo "No relevant files changed - skipping security audit"

      - name: Notify (ntfy)
        if: always() && steps.changed-files.outputs.has_changes == 'true'
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          if [ -z "$NTFY_TOPIC" ]; then exit 0; fi

          CRITICAL="${{ steps.audit.outputs.critical_count || 0 }}"
          HIGH="${{ steps.audit.outputs.high_count || 0 }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if [ "${CRITICAL:-0}" -gt 0 ] || [ "${HIGH:-0}" -gt 0 ]; then
            PRIORITY=5; TAG="rotating_light"
            STATUS="Issues Found"
          else
            PRIORITY=2; TAG="white_check_mark"
            STATUS="Clean"
          fi

          curl -s -o /dev/null \
            -H "Title: PR #${PR_NUM} Audit - $STATUS" \
            -H "Priority: $PRIORITY" \
            -H "Tags: $TAG" \
            -H "Click: https://github.com/${{ github.repository }}/pull/${PR_NUM}" \
            -d "Critical: ${CRITICAL:-0} | High: ${HIGH:-0} | PR: ${PR_TITLE}" \
            "https://ntfy.sh/$NTFY_TOPIC" || true
