# thea-audit-pr.yml
# Security audit workflow for Pull Requests (delta mode)

name: Security Audit (PR)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'Shared/**'
      - 'Tests/**'
      - 'Tools/**'
      - 'Scripts/**'
      - '.github/workflows/**'
      - 'Package.swift'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: Security Audit (Delta)
    runs-on: macos-14
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5c0da4bc0bdda74f6e70e06f0ebdee8b # v2.2.0
        with:
          swift-version: "6.0"

      - name: Cache Swift packages
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: Tools/thea-audit/.build
          key: ${{ runner.os }}-spm-thea-audit-${{ hashFiles('Tools/thea-audit/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-thea-audit-

      - name: Build thea-audit
        working-directory: Tools/thea-audit
        run: |
          swift build -c release
          echo "THEA_AUDIT=$(pwd)/.build/release/thea-audit" >> $GITHUB_ENV

      - name: Get changed files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep -E '\.(swift|ts|tsx|yml|yaml|sh)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No relevant files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Save to file for thea-audit
            echo "$CHANGED_FILES" > /tmp/changed_files.txt
          fi

      - name: Run security audit (delta mode)
        if: steps.changed-files.outputs.has_changes == 'true'
        id: audit
        run: |
          set +e

          $THEA_AUDIT audit \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format yaml \
            --output audit-results.yaml \
            --policy thea-policy.json \
            --strict

          AUDIT_EXIT_CODE=$?
          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT

          # Generate markdown summary
          $THEA_AUDIT audit \
            --path . \
            --delta \
            --base-branch origin/${{ github.base_ref }} \
            --format markdown \
            --output audit-summary.md \
            --policy thea-policy.json

          exit 0

      - name: Upload audit results
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-audit-pr-${{ github.event.pull_request.number }}
          path: |
            audit-results.yaml
            audit-summary.md
          retention-days: 30

      - name: Comment on PR
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            let summary = '## ðŸ”’ Security Audit Results\n\n';

            // Read audit summary if it exists
            if (fs.existsSync('audit-summary.md')) {
              const auditSummary = fs.readFileSync('audit-summary.md', 'utf8');
              summary += auditSummary;
            } else {
              summary += 'âœ… No security issues found in changed files.\n';
            }

            // Add footer
            summary += '\n---\n';
            summary += '*Generated by [thea-audit](Tools/thea-audit) security scanner*\n';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Security Audit Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Check audit status
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          if [ "${{ steps.audit.outputs.exit_code }}" != "0" ]; then
            echo "::error::Security audit found critical or high severity issues"
            echo "Please review the audit results and fix the identified issues."
            exit 1
          fi
          echo "âœ… Security audit passed"

      - name: Skip audit (no relevant changes)
        if: steps.changed-files.outputs.has_changes != 'true'
        run: |
          echo "âœ… No relevant files changed - skipping security audit"
