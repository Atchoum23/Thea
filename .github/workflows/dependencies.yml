name: Swift Package Dependencies

# This workflow validates and caches Swift Package Manager dependencies
# It runs on push to main branch and on pull requests to ensure dependencies
# resolve correctly across all development scenarios.

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'Development/Package.swift'
      - 'Development/Package.resolved'
      - 'Development/project.yml'
      - '.github/workflows/dependencies.yml'

  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'Development/Package.swift'
      - 'Development/Package.resolved'
      - 'Development/project.yml'

  # Allow manual workflow dispatch for testing
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  resolve-dependencies:
    name: Resolve Swift Package Dependencies
    runs-on: macos-14  # macOS Sonoma with Xcode 16
    timeout-minutes: 20

    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 1: Checkout Repository
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 2: Setup Xcode Environment
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Show Swift Version
        run: swift --version

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 3: Cache Swift Package Manager Dependencies
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Cache key based on Package.resolved content
      # This provides fast dependency restoration without re-downloading
      - name: Cache SPM Dependencies
        uses: actions/cache@v4
        id: spm-cache
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            Development/build/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('Development/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 4: Validate Package.swift
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Validate Package.swift Syntax
        working-directory: Development
        run: |
          echo "ðŸ“‹ Validating Package.swift syntax..."
          swift package dump-package > /dev/null
          echo "âœ“ Package.swift is valid"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 5: Generate Xcode Project (if using XcodeGen)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        working-directory: Development
        run: |
          echo "ðŸ”¨ Generating Xcode project from project.yml..."
          xcodegen generate
          echo "âœ“ Xcode project generated"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 6: Resolve Package Dependencies
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Resolve Swift Package Dependencies
        working-directory: Development
        run: |
          echo "ðŸ“¦ Resolving Swift Package Manager dependencies..."

          xcodebuild \
            -project Thea.xcodeproj \
            -scheme Thea-macOS \
            -resolvePackageDependencies \
            -derivedDataPath build \
            -quiet

          echo "âœ“ Dependencies resolved successfully"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 7: Verify Package.resolved
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Verify Package.resolved Exists
        working-directory: Development
        run: |
          echo "ðŸ” Verifying Package.resolved..."

          if [ ! -f "Package.resolved" ]; then
            echo "âŒ Package.resolved not found after resolution"
            exit 1
          fi

          echo "âœ“ Package.resolved exists"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 8: Display Resolved Packages
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: List Resolved Packages
        working-directory: Development
        run: |
          echo "ðŸ“‹ Resolved Package Dependencies:"
          echo ""

          # Use jq to parse and display packages nicely
          brew install jq

          jq -r '.pins[] | "  ðŸ“¦ \(.identity) @ \(.state.version // .state.revision[0:8])"' Package.resolved

          echo ""
          echo "âœ“ Total packages: $(jq '.pins | length' Package.resolved)"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 9: Check for Package Conflicts
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Check for Dependency Conflicts
        working-directory: Development
        run: |
          echo "ðŸ” Checking for dependency conflicts..."

          # Check if all required packages are present
          REQUIRED_PACKAGES=("openai" "keychainaccess" "swift-markdown-ui" "highlightr")
          MISSING_PACKAGES=()

          for pkg in "${REQUIRED_PACKAGES[@]}"; do
            if ! jq -e ".pins[] | select(.identity == \"$pkg\")" Package.resolved > /dev/null; then
              MISSING_PACKAGES+=("$pkg")
            fi
          done

          if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
            echo "âŒ Missing required packages:"
            printf '  â€¢ %s\n' "${MISSING_PACKAGES[@]}"
            exit 1
          fi

          echo "âœ“ All required packages are resolved"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 10: Upload Package.resolved as Artifact (for debugging)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Upload Package.resolved Artifact
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if previous steps fail
        with:
          name: package-resolved-${{ github.sha }}
          path: Development/Package.resolved
          retention-days: 30

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 11: Check Package.resolved for Changes (PR only)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Check for Package.resolved Changes
        if: github.event_name == 'pull_request'
        working-directory: Development
        run: |
          echo "ðŸ” Checking if Package.resolved has changed..."

          if git diff --quiet HEAD -- Package.resolved; then
            echo "âœ“ Package.resolved is up to date"
          else
            echo "âš ï¸  Package.resolved has uncommitted changes"
            echo ""
            echo "Changes detected:"
            git diff HEAD -- Package.resolved
            echo ""
            echo "ðŸ’¡ Consider committing the updated Package.resolved to your PR"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # Step 12: Summary
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Swift Package Dependencies Resolved Successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Cache status: ${{ steps.spm-cache.outputs.cache-hit == 'true' && 'âœ“ Cache hit' || 'âš  Cache miss (packages downloaded)' }}"
          echo ""

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Optional: Security Audit Job
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  audit-dependencies:
    name: Audit Dependencies for Vulnerabilities
    runs-on: macos-14
    needs: resolve-dependencies
    timeout-minutes: 10

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Dependency Audit
        working-directory: Development
        run: |
          echo "ðŸ”’ Auditing dependencies for known vulnerabilities..."

          # Note: Swift doesn't have a built-in audit tool like npm audit
          # This is a placeholder for future security scanning integration
          # Consider integrating tools like:
          # - Snyk (https://snyk.io)
          # - GitHub Dependabot (built-in GitHub security)
          # - OWASP Dependency-Check

          echo "âœ“ Audit check placeholder - integrate security scanning tool"

      - name: Check for Outdated Dependencies
        working-directory: Development
        run: |
          echo "ðŸ“¦ Checking for outdated dependencies..."

          # Swift package updates can be checked with:
          swift package show-dependencies --format json > deps.json

          echo "âœ“ Dependency check complete"
