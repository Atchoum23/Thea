# Thea Swift Package Dependencies Workflow
# Version: 2.0.0 - Optimized with pinned actions, streamlined validation
# Last Updated: January 27, 2026

name: Swift Package Dependencies

on:
  push:
    branches: [main, develop]
    paths:
      - 'Package.swift'
      - 'Package.resolved'
      - 'project.yml'
      - '.github/workflows/dependencies.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'Package.swift'
      - 'Package.resolved'
      - 'project.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '16.2'
  DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer

jobs:
  resolve-dependencies:
    name: Resolve Swift Package Dependencies
    runs-on: macos-14
    timeout-minutes: 20

    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Show Environment
        run: |
          echo "Xcode: $(xcodebuild -version | head -1)"
          echo "Swift: $(swift --version | head -1)"

      - name: Cache SPM Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.1.2
        id: spm-cache
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Validate Package.swift Syntax
        run: |
          echo "Validating Package.swift syntax..."
          swift package dump-package > /dev/null
          echo "Package.swift is valid"

      - name: Cache XcodeGen
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.1.2
        with:
          path: /opt/homebrew/Cellar/xcodegen
          key: ${{ runner.os }}-xcodegen-2.42.0

      - name: Install XcodeGen
        run: command -v xcodegen || brew install xcodegen

      - name: Generate Xcode Project
        run: |
          echo "Generating Xcode project from project.yml..."
          xcodegen generate
          echo "Xcode project generated"

      - name: Resolve Swift Package Dependencies
        run: |
          echo "Resolving Swift Package Manager dependencies..."
          xcodebuild \
            -project Thea.xcodeproj \
            -scheme Thea-macOS \
            -resolvePackageDependencies \
            -derivedDataPath build \
            -quiet
          echo "Dependencies resolved successfully"

      - name: Verify Package.resolved Exists
        run: |
          if [ ! -f "Package.resolved" ]; then
            echo "::error::Package.resolved not found after resolution"
            exit 1
          fi
          echo "Package.resolved exists"

      - name: List Resolved Packages
        run: |
          echo "Resolved Package Dependencies:"
          echo ""

          # Install jq if needed
          command -v jq || brew install jq

          jq -r '.pins[] | "  - \(.identity) @ \(.state.version // .state.revision[0:8])"' Package.resolved
          echo ""
          echo "Total packages: $(jq '.pins | length' Package.resolved)"

      - name: Check for Required Packages
        run: |
          echo "Checking for required packages..."

          REQUIRED_PACKAGES=("openai" "keychainaccess" "swift-markdown-ui" "highlightr")
          MISSING_PACKAGES=()

          for pkg in "${REQUIRED_PACKAGES[@]}"; do
            if ! jq -e ".pins[] | select(.identity == \"$pkg\")" Package.resolved > /dev/null; then
              MISSING_PACKAGES+=("$pkg")
            fi
          done

          if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
            echo "::error::Missing required packages: ${MISSING_PACKAGES[*]}"
            exit 1
          fi

          echo "All required packages are resolved"

      - name: Upload Package.resolved Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        if: always()
        with:
          name: package-resolved-${{ github.sha }}
          path: Package.resolved
          retention-days: 30

      - name: Check for Package.resolved Changes (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking if Package.resolved has changed..."

          if git diff --quiet HEAD -- Package.resolved; then
            echo "Package.resolved is up to date"
          else
            echo "::warning::Package.resolved has uncommitted changes"
            echo ""
            echo "Changes detected:"
            git diff HEAD -- Package.resolved
            echo ""
            echo "Consider committing the updated Package.resolved to your PR"
          fi

      - name: Summary
        if: success()
        run: |
          echo "## Swift Package Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cache | ${{ steps.spm-cache.outputs.cache-hit == 'true' && 'Hit' || 'Miss' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Packages | $(jq '.pins | length' Package.resolved) |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Resolved |" >> $GITHUB_STEP_SUMMARY
