# Thea E2E Tests Workflow
# Version: 4.0.0 - Added .maestro/ existence check, screenshot-on-failure, fixed artifact name
#                  inconsistency (maestro-results.log → maestro-output.log), ntfy notifications
# Root cause of previous failure: Xcode 26.2 debug dylib build system strips
# the main executable when packaging as artifact then unzipping. Fixed by
# building and testing on the same runner — no artifact transfer needed.

name: Thea E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [labeled]
  workflow_dispatch:
  schedule:
    # Run nightly at 3 AM UTC for regression testing
    - cron: '0 3 * * *'

permissions: read-all

env:
  XCODE_VERSION: '26.2'
  DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer
  MAESTRO_DRIVER_STARTUP_TIMEOUT: 300000  # 5 minutes for driver startup

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # SINGLE JOB: BUILD + TEST (same runner)
  # Avoids artifact transfer which loses the executable on Xcode 26.2
  # ============================================
  build-and-test:
    name: Build + Maestro E2E Tests
    runs-on: macos-26
    timeout-minutes: 90
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'e2e')

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Xcode and XcodeGen
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: '26.2'
          scheme: Thea-iOS

      - name: Cache DerivedData
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ runner.temp }}/TheaBuild
          key: ${{ runner.os }}-e2e-deriveddata-${{ hashFiles('project.yml', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-e2e-deriveddata-

      - name: List Available Simulators
        run: |
          echo "=== Available iOS Simulators ==="
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20

      - name: Boot Simulator
        id: simulator
        run: |
          # Try iPhone 16 first, then 15, then any iPhone as fallback
          SIM_UDID=$(xcrun simctl list devices available --json | python3 -c "
          import json,sys
          devices=json.load(sys.stdin)['devices']
          for runtime,devs in sorted(devices.items(), reverse=True):
            if 'iOS' not in runtime: continue
            for d in devs:
              if 'iPhone 16' in d['name']:
                print(d['udid']); sys.exit(0)
          for runtime,devs in sorted(devices.items(), reverse=True):
            if 'iOS' not in runtime: continue
            for d in devs:
              if 'iPhone 15' in d['name']:
                print(d['udid']); sys.exit(0)
          for runtime,devs in sorted(devices.items(), reverse=True):
            if 'iOS' not in runtime: continue
            for d in devs:
              if 'iPhone' in d['name']:
                print(d['udid']); sys.exit(0)
          sys.exit(1)
          ") || { echo '::error::No iPhone simulator found'; exit 1; }

          DEVICE_NAME=$(xcrun simctl list devices available --json | python3 -c "
          import json,sys
          devices=json.load(sys.stdin)['devices']
          for runtime,devs in devices.items():
            for d in devs:
              if d['udid'] == '$SIM_UDID':
                print(d['name']); sys.exit(0)
          ")

          echo "Selected simulator: $DEVICE_NAME ($SIM_UDID)"
          echo "device_id=$SIM_UDID" >> "$GITHUB_OUTPUT"
          echo "device_name=$DEVICE_NAME" >> "$GITHUB_OUTPUT"

          # Boot
          xcrun simctl boot "$SIM_UDID" 2>/dev/null || true
          xcrun simctl bootstatus "$SIM_UDID" -b
          echo "Simulator booted."

      - name: Build iOS Simulator App
        run: |
          DERIVED_DATA="$RUNNER_TEMP/TheaBuild"
          mkdir -p "$DERIVED_DATA"

          echo "Building Thea-iOS for simulator: ${{ steps.simulator.outputs.device_name }}"

          # TODO FB12345678: Xcode 26 debug dylib workaround — revisit when Xcode is updated
          # ENABLE_DEBUG_DYLIB=NO: forces Xcode 26 to produce a real executable
          # (not the new debug dylib which breaks installation)
          # ONLY_ACTIVE_ARCH=YES + ARCHS=arm64: macos-26 runners are arm64
          xcodebuild build \
            -project Thea.xcodeproj \
            -scheme Thea-iOS \
            -destination "platform=iOS Simulator,id=${{ steps.simulator.outputs.device_id }}" \
            -configuration Debug \
            -derivedDataPath "$DERIVED_DATA" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ENABLE_DEBUG_DYLIB=NO \
            ONLY_ACTIVE_ARCH=YES \
            ARCHS=arm64 \
            SWIFT_STRICT_CONCURRENCY=complete \
            2>&1 | tee "$RUNNER_TEMP/build.log"

          BUILD_EXIT=${PIPESTATUS[0]}
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "::error::Build failed with exit code $BUILD_EXIT"
            grep -E "^.*error:.*$" "$RUNNER_TEMP/build.log" | head -30 || true
            exit $BUILD_EXIT
          fi

          echo "Build succeeded."
          echo "derived_data=$DERIVED_DATA" >> "$GITHUB_ENV"

      - name: Locate App Bundle
        id: locate-app
        run: |
          APP_PATH=$(find "$derived_data" -name "Thea.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "::error::Thea.app not found in DerivedData"
            find "$derived_data" -name "*.app" -type d | head -10 || echo "No .app found"
            exit 1
          fi

          echo "app_path=$APP_PATH" >> "$GITHUB_OUTPUT"
          echo "Found app at: $APP_PATH"
          echo ""
          echo "=== Bundle contents ==="
          ls -la "$APP_PATH"
          echo ""

          # Find the executable — try CFBundleExecutable from Info.plist, then fallback
          EXECUTABLE=$(defaults read "$APP_PATH/Info.plist" CFBundleExecutable 2>/dev/null || echo "Thea")
          if [ -f "$APP_PATH/$EXECUTABLE" ]; then
            echo "Executable found: $APP_PATH/$EXECUTABLE"
            file "$APP_PATH/$EXECUTABLE"
          else
            echo "::error::Executable '$EXECUTABLE' not found in bundle"
            echo "All files in bundle:"
            find "$APP_PATH" -maxdepth 2 | sort
            exit 1
          fi

      - name: Install App on Simulator
        run: |
          APP_PATH="${{ steps.locate-app.outputs.app_path }}"
          DEVICE_ID="${{ steps.simulator.outputs.device_id }}"

          for attempt in 1 2 3; do
            echo "Install attempt $attempt..."
            if xcrun simctl install "$DEVICE_ID" "$APP_PATH"; then
              echo "App installed"
              break
            fi
            if [ $attempt -lt 3 ]; then
              sleep 5
              xcrun simctl shutdown "$DEVICE_ID" 2>/dev/null || true
              sleep 3
              xcrun simctl boot "$DEVICE_ID" 2>/dev/null || true
              xcrun simctl bootstatus "$DEVICE_ID" -b
            else
              echo "::error::Failed to install app after 3 attempts"
              exit 1
            fi
          done

      - name: Cache Maestro
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.maestro
          key: ${{ runner.os }}-maestro-1.38.1

      - name: Install Maestro
        run: |
          if [ ! -f "$HOME/.maestro/bin/maestro" ]; then
            curl -Ls "https://get.maestro.mobile.dev?version=1.38.1" | bash
          fi
          echo "$HOME/.maestro/bin" >> "$GITHUB_PATH"
          "$HOME/.maestro/bin/maestro" --version

      - name: Check Maestro Flows Exist
        id: check-flows
        run: |
          if [ ! -d ".maestro" ]; then
            echo "::warning::No .maestro/ directory found — E2E test flows are missing"
            echo "has_flows=false" >> "$GITHUB_OUTPUT"
          else
            FLOW_COUNT=$(find .maestro -maxdepth 2 \( -name "*.yaml" -o -name "*.yml" \) | wc -l | tr -d ' ')
            if [ "$FLOW_COUNT" -eq 0 ]; then
              echo "::warning::No Maestro .yaml/.yml flow files found in .maestro/"
              echo "has_flows=false" >> "$GITHUB_OUTPUT"
            else
              echo "Found $FLOW_COUNT Maestro flow file(s)"
              echo "has_flows=true" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Run Maestro E2E Tests
        id: maestro
        run: |
          export PATH="$HOME/.maestro/bin:$PATH"
          mkdir -p maestro-results

          if [ "${{ steps.check-flows.outputs.has_flows }}" != "true" ]; then
            echo "No Maestro flows found — skipping test run"
            echo "exit_code=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          maestro test .maestro/ \
            --format junit \
            --output maestro-results/results.xml \
            --device "${{ steps.simulator.outputs.device_id }}" \
            2>&1 | tee maestro-output.log
          MAESTRO_EXIT=${PIPESTATUS[0]}
          echo "exit_code=$MAESTRO_EXIT" >> "$GITHUB_OUTPUT"

      - name: Capture Simulator Screenshot on Failure
        if: failure()
        run: |
          DEVICE_ID="${{ steps.simulator.outputs.device_id }}"
          if [ -n "$DEVICE_ID" ]; then
            mkdir -p maestro-results
            xcrun simctl io "$DEVICE_ID" screenshot maestro-results/failure-screenshot.png 2>/dev/null || true
            echo "Failure screenshot captured"
          fi

      - name: Upload Maestro Artifacts on Failure
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: maestro-failure-${{ github.sha }}
          path: |
            ~/.maestro/tests/
            maestro-output.log
            maestro-results/failure-screenshot.png
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: e2e-build-log
          path: ${{ runner.temp }}/build.log
          retention-days: 7

      - name: Upload Maestro Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: maestro-results
          path: |
            maestro-results/
            maestro-output.log
          retention-days: 30

      - name: Publish Test Results
        if: always()
        uses: mikepenz/action-junit-report@db71d41eb79864e25ab0337e395c352e84523afe # v4.3.1
        with:
          report_paths: 'maestro-results/results.xml'
          check_name: 'Maestro E2E Test Results'
          fail_on_failure: true

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ steps.simulator.outputs.device_id }}" 2>/dev/null || true

      - name: Final Result
        run: |
          if [ "${{ steps.maestro.outputs.exit_code }}" != "0" ]; then
            echo "::error::Maestro E2E tests failed — see maestro-results artifact"
            exit 1
          fi
          echo "All Maestro E2E tests passed"

      - name: Notify (ntfy)
        if: always()
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          if [ -z "$NTFY_TOPIC" ]; then exit 0; fi

          EXIT="${{ steps.maestro.outputs.exit_code }}"
          if [ "$EXIT" = "0" ]; then
            PRIORITY=3; TAG="white_check_mark"; STATUS="Passed"
          else
            PRIORITY=5; TAG="rotating_light"; STATUS="FAILED"
          fi

          curl -s -o /dev/null \
            -H "Title: Thea E2E - $STATUS" \
            -H "Priority: $PRIORITY" \
            -H "Tags: $TAG" \
            -H "Click: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -d "Maestro E2E $STATUS on ${{ github.ref_name }} (simulator: ${{ steps.simulator.outputs.device_name }})" \
            "https://ntfy.sh/$NTFY_TOPIC" || true
