# thea-audit-main.yml
# Full security audit workflow for main branch

name: Security Audit (Full)

on:
  push:
    branches:
      - main
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'low'
        type: choice
        options:
          - critical
          - high
          - medium
          - low
      verbose:
        description: 'Enable verbose output'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: Full Security Audit
    runs-on: macos-14
    permissions:
      contents: read
      issues: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Setup Swift
        uses: swift-actions/setup-swift@3aed395c5c0da4bc0bdda74f6e70e06f0ebdee8b # v2.2.0
        with:
          swift-version: "6.0"

      - name: Cache Swift packages
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: Tools/thea-audit/.build
          key: ${{ runner.os }}-spm-thea-audit-${{ hashFiles('Tools/thea-audit/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-thea-audit-

      - name: Build thea-audit
        working-directory: Tools/thea-audit
        run: |
          swift build -c release
          echo "THEA_AUDIT=$(pwd)/.build/release/thea-audit" >> $GITHUB_ENV

      - name: Run full security audit
        id: audit
        run: |
          set +e

          SEVERITY="${{ github.event.inputs.severity || 'low' }}"
          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.verbose }}" == "true" ]; then
            VERBOSE_FLAG="--verbose"
          fi

          # Run full audit with YAML output
          $THEA_AUDIT audit \
            --path . \
            --format yaml \
            --output audit-results.yaml \
            --severity "$SEVERITY" \
            --policy thea-policy.json \
            $VERBOSE_FLAG

          AUDIT_EXIT_CODE=$?
          echo "exit_code=$AUDIT_EXIT_CODE" >> $GITHUB_OUTPUT

          # Run full audit with JSON output for processing
          $THEA_AUDIT audit \
            --path . \
            --format json \
            --output audit-results.json \
            --severity "$SEVERITY" \
            --policy thea-policy.json

          # Generate markdown report
          $THEA_AUDIT audit \
            --path . \
            --format markdown \
            --output audit-report.md \
            --severity "$SEVERITY" \
            --policy thea-policy.json

          # Count findings by severity
          CRITICAL_COUNT=$(grep -c '"severity": "critical"' audit-results.json 2>/dev/null || echo 0)
          HIGH_COUNT=$(grep -c '"severity": "high"' audit-results.json 2>/dev/null || echo 0)
          MEDIUM_COUNT=$(grep -c '"severity": "medium"' audit-results.json 2>/dev/null || echo 0)
          LOW_COUNT=$(grep -c '"severity": "low"' audit-results.json 2>/dev/null || echo 0)

          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT

          exit 0

      - name: Generate SARIF output
        if: always()
        run: |
          # Convert audit results to SARIF format for GitHub Security tab
          $THEA_AUDIT audit \
            --path . \
            --format sarif \
            --output audit-results.sarif \
            --policy thea-policy.json || true

      - name: Upload SARIF to GitHub Security
        if: always() && hashFiles('audit-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1
        with:
          sarif_file: audit-results.sarif
          category: thea-audit

      - name: Upload audit artifacts
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-audit-full-${{ github.sha }}
          path: |
            audit-results.yaml
            audit-results.json
            audit-report.md
            audit-results.sarif
          retention-days: 90

      - name: Create issue on critical findings
        if: steps.audit.outputs.critical_count > 0
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');

            const criticalCount = ${{ steps.audit.outputs.critical_count }};
            const highCount = ${{ steps.audit.outputs.high_count }};

            // Read the report
            let reportContent = '';
            if (fs.existsSync('audit-report.md')) {
              reportContent = fs.readFileSync('audit-report.md', 'utf8');
            }

            const title = `ðŸš¨ Security Audit: ${criticalCount} Critical Finding(s) Detected`;

            const body = `## Security Audit Alert

            A full security audit has detected critical security issues that require immediate attention.

            ### Summary
            - ðŸ”´ **Critical**: ${criticalCount}
            - ðŸŸ  **High**: ${highCount}

            ### Commit
            - SHA: \`${{ github.sha }}\`
            - Ref: \`${{ github.ref }}\`

            ### Full Report
            ${reportContent}

            ---

            **Action Required**: Please review and address these findings immediately.

            *This issue was automatically created by the [thea-audit](Tools/thea-audit) security scanner.*
            `;

            // Check for existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,critical'
            });

            const existingIssue = issues.find(issue =>
              issue.title.includes('Security Audit') &&
              issue.title.includes('Critical')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Audit Results\n\nCommit: \`${{ github.sha }}\`\n\n${reportContent}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'critical', 'automated']
              });
            }

      - name: Update job summary
        if: always()
        run: |
          echo "## ðŸ”’ Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”´ Critical | ${{ steps.audit.outputs.critical_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ  High | ${{ steps.audit.outputs.high_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ Medium | ${{ steps.audit.outputs.medium_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”µ Low | ${{ steps.audit.outputs.low_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "audit-report.md" ]; then
            echo "### Detailed Report" >> $GITHUB_STEP_SUMMARY
            cat audit-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check audit status
        run: |
          CRITICAL=${{ steps.audit.outputs.critical_count }}
          HIGH=${{ steps.audit.outputs.high_count }}

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Security audit found $CRITICAL critical severity issue(s)"
            exit 1
          fi

          if [ "$HIGH" -gt 0 ]; then
            echo "::warning::Security audit found $HIGH high severity issue(s)"
          fi

          echo "âœ… Security audit completed"
