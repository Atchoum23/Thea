# Thea Security Scanning Workflow
# Version: 1.0.0 - Gitleaks secret scanning + dependency audit
# Last Updated: February 10, 2026

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 4 AM UTC
    - cron: '0 4 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # GITLEAKS - Secret Detection
  # ============================================
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@44c470ffc35caa8b1eb3e8012ca53c2f9bea4eb5 # v2.3.7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # DEPENDENCY AUDIT - Vulnerability Scanning
  # ============================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Audit Package.resolved
        run: |
          echo "## Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "Package.resolved" ]; then
            echo "Package.resolved found - listing dependencies:" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat Package.resolved | python3 -m json.tool 2>/dev/null | head -100 >> $GITHUB_STEP_SUMMARY || cat Package.resolved | head -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Count dependencies
            DEP_COUNT=$(python3 -c "import json; d=json.load(open('Package.resolved')); print(len(d.get('pins', d.get('object', {}).get('pins', []))))" 2>/dev/null || echo "unknown")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total dependencies: $DEP_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Package.resolved found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for Known Vulnerabilities
        run: |
          # Extract dependency URLs and versions from Package.resolved
          if [ -f "Package.resolved" ]; then
            python3 << 'PYEOF'
          import json
          import sys

          with open("Package.resolved") as f:
              data = json.load(f)

          # Handle both v1 and v2 Package.resolved formats
          pins = data.get("pins", data.get("object", {}).get("pins", []))

          print(f"Found {len(pins)} dependencies:")
          for pin in pins:
              name = pin.get("identity", pin.get("package", "unknown"))
              url = pin.get("location", pin.get("repositoryURL", "unknown"))
              state = pin.get("state", {})
              version = state.get("version", state.get("revision", "unknown")[:12])
              print(f"  {name}: {version} ({url})")
          PYEOF
          fi

  # ============================================
  # SECURITY SUMMARY
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, dependency-audit]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gitleaks.result }}" == "success" ]]; then
            echo "| Secret Scanning (Gitleaks) | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Scanning (Gitleaks) | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.dependency-audit.result }}" == "success" ]]; then
            echo "| Dependency Audit | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical checks failed
        if: needs.gitleaks.result == 'failure'
        run: |
          echo "::error::Security scanning failed - secrets detected"
          exit 1
