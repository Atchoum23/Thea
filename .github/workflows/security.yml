# Thea Security Scanning Workflow
# Version: 2.0.0 - Fixed 6 issues (P0: real CVE scanning via osv-scanner, gitleaks permissions; P1: top-level permissions, concurrency, summary fail; P2: gitleaks config)
# Last Updated: February 17, 2026

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 4 AM UTC
    - cron: '0 4 * * 1'

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # GITLEAKS - Secret Detection
  # ============================================
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@44c470ffc35caa8b1eb3e8012ca53c2f9bea4eb5 # v2.3.7
        with:
          config-path: .gitleaks.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # DEPENDENCY AUDIT - CVE Scanning (osv-scanner)
  # ============================================
  dependency-audit:
    name: CVE Scanning (osv-scanner)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run OSV Scanner (JSON)
        uses: google/osv-scanner-action@v2
        with:
          scan-args: |-
            --output=results.json
            --format=json
            ./
        continue-on-error: true

      - name: Run OSV Scanner (SARIF)
        uses: google/osv-scanner-action@v2
        with:
          scan-args: |-
            --output=results.sarif
            --format=sarif
            ./
        continue-on-error: true

      - name: Upload OSV Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: osv-scan-results-${{ github.sha }}
          path: |
            results.json
            results.sarif
          retention-days: 30

      - name: Upload SARIF to GitHub Security
        if: always() && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@4f3212b61783c3c68e8309a0f18a699764811cda # v3.27.1
        with:
          sarif_file: results.sarif
          category: osv-scanner

      - name: Check for Critical Vulnerabilities
        if: always()
        run: |
          if [ -f results.json ]; then
            CRITICAL=$(python3 -c "
          import json, sys
          try:
            d = json.load(open('results.json'))
            vulns = d.get('results', [])
            critical = sum(1 for r in vulns for v in r.get('vulnerabilities', [])
                           if any(s.get('type') == 'CVSS_V3' and float(s.get('score', 0)) >= 9.0
                                  for s in v.get('severity', [])))
            print(critical)
          except: print(0)
          ")
            if [ "$CRITICAL" -gt "0" ]; then
              echo "::error::OSV scanner found $CRITICAL critical CVEs"
              exit 1
            fi
            echo "OSV scan complete â€” no critical CVEs found"
          fi

  # ============================================
  # SECURITY SUMMARY
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, dependency-audit]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gitleaks.result }}" == "success" ]]; then
            echo "| Secret Scanning (Gitleaks) | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Scanning (Gitleaks) | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.dependency-audit.result }}" == "success" ]]; then
            echo "| CVE Scanning (osv-scanner) | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CVE Scanning (osv-scanner) | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical checks failed
        if: needs.gitleaks.result == 'failure' || needs.dependency-audit.result == 'failure'
        run: |
          echo "::error::Security checks failed"
          exit 1
