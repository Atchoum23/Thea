# Thea Security Scanning Workflow
# Version: 2.0.0 - Phase E: OSV scanner direct CLI, gitleaks env var config, permissions, concurrency fix
# Last Updated: February 18, 2026

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 4 AM UTC
    - cron: '0 4 * * 1'

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # GITLEAKS - Secret Detection
  # ============================================
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@44c470ffc35caa8b1eb3e8012ca53c2f9bea4eb5 # v2.3.7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  # ============================================
  # DEPENDENCY AUDIT - CVE Scanning (osv-scanner)
  # ============================================
  dependency-audit:
    name: CVE Scanning (osv-scanner)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@cdcb36043654635082a3a68ef0dd1a68b0be0036 # v5.0.0
        with:
          go-version: 'stable'
          cache: false

      - name: Install OSV Scanner
        run: go install github.com/google/osv-scanner/cmd/osv-scanner@latest

      - name: Run OSV Scanner
        id: osv
        run: |
          OSV_BIN="$(go env GOPATH)/bin/osv-scanner"
          if [ ! -f "$OSV_BIN" ]; then
            OSV_BIN="$HOME/go/bin/osv-scanner"
          fi

          if [ -f "Package.resolved" ]; then
            "$OSV_BIN" --lockfile Package.resolved --format json > osv-results.json 2>&1 || true
          fi

          # Count vulnerabilities from output
          if [ -f osv-results.json ]; then
            CRITICAL=$(python3 -c "
          import json, sys
          try:
            d = json.load(open('osv-results.json'))
            results = d.get('results', [])
            critical = sum(1 for r in results for v in r.get('vulnerabilities', [])
                           if any(s.get('type') == 'CVSS_V3' and float(s.get('score', 0)) >= 9.0
                                  for s in v.get('severity', [])))
            print(critical)
          except Exception as e:
            print(0)
          " 2>/dev/null || echo 0)
            echo "critical_count=$CRITICAL" >> $GITHUB_OUTPUT
            echo "OSV scan complete. Critical CVEs: $CRITICAL"
          else
            echo "critical_count=0" >> $GITHUB_OUTPUT
            echo "No Package.resolved found or scan produced no output"
          fi

      - name: Upload OSV Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: osv-scan-results-${{ github.sha }}
          path: osv-results.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Check for Critical Vulnerabilities
        if: always()
        run: |
          CRITICAL="${{ steps.osv.outputs.critical_count }}"
          if [ "${CRITICAL:-0}" -gt "0" ]; then
            echo "::error::OSV scanner found $CRITICAL critical CVEs"
            exit 1
          fi
          echo "OSV scan complete â€” no critical CVEs found"

      - name: Audit Package.resolved (Summary)
        run: |
          echo "## Dependency Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "Package.resolved" ]; then
            # Count dependencies
            DEP_COUNT=$(python3 -c "import json; d=json.load(open('Package.resolved')); print(len(d.get('pins', d.get('object', {}).get('pins', []))))" 2>/dev/null || echo "unknown")
            echo "Total dependencies: $DEP_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # List dependencies
            python3 << 'PYEOF'
          import json
          import sys

          with open("Package.resolved") as f:
              data = json.load(f)

          # Handle both v1 and v2 Package.resolved formats
          pins = data.get("pins", data.get("object", {}).get("pins", []))

          print(f"Found {len(pins)} dependencies:")
          for pin in pins:
              name = pin.get("identity", pin.get("package", "unknown"))
              url = pin.get("location", pin.get("repositoryURL", "unknown"))
              state = pin.get("state", {})
              version = state.get("version", state.get("revision", "unknown")[:12])
              print(f"  {name}: {version} ({url})")
          PYEOF
          else
            echo "No Package.resolved found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # SECURITY SUMMARY
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, dependency-audit]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.gitleaks.result }}" == "success" ]]; then
            echo "| Secret Scanning (Gitleaks) | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Scanning (Gitleaks) | ${{ needs.gitleaks.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.dependency-audit.result }}" == "success" ]]; then
            echo "| CVE Scanning (osv-scanner) | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| CVE Scanning (osv-scanner) | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical checks failed
        if: needs.gitleaks.result == 'failure' || needs.dependency-audit.result == 'failure'
        run: |
          echo "::error::Security checks failed"
          exit 1
