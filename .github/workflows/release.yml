name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Release with SPM
        run: swift build -c release -v

      - name: Create Release Directory
        run: |
          mkdir -p release
          cp -R .build/release/Thea release/ || cp -R .build/release/TheaPackage release/Thea

      - name: Create Release Archive
        run: |
          cd release
          zip -r ../Thea-${{ steps.version.outputs.version }}-macOS.zip Thea
          cd ..

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          ## Thea v${{ steps.version.outputs.version }}

          ### ðŸŽ‰ Features
          - **Automatic Prompt Engineering**: Meta-AI optimization for perfect AI responses
          - **Swift Code Excellence**: Zero-error learning system for Swift development
          - **Multi-Window Support**: Advanced macOS window and tab management
          - **Life Tracking**: Health, screen time, location, and activity tracking

          ### ðŸ”’ Privacy-First Design
          - All data stored locally with SwiftData
          - Optional CloudKit sync for your devices only
          - No third-party analytics or telemetry

          ### ðŸ› ï¸ Technical Details
          - Swift 6.0 with strict concurrency
          - SwiftUI for macOS 14.0+ and iOS 17.0+
          - SwiftData for local persistence
          - HealthKit integration (iOS/watchOS)
          - CoreLocation integration (iOS)
          - Accessibility-based tracking (macOS)

          ### ðŸ“¦ Installation

          **macOS:**
          1. Download `Thea-${{ steps.version.outputs.version }}-macOS.zip`
          2. Unzip and move Thea to /Applications
          3. Launch Thea from Applications folder

          ### ðŸ”§ Requirements
          - macOS 14.0 (Sonoma) or later
          - iOS 17.0 or later (for iOS version)
          - Swift 6.0 compatible Xcode

          ### âœ… Quality Metrics
          - Zero compilation errors
          - Zero warnings
          - Zero SwiftLint violations
          - Production-ready build
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            Thea-${{ steps.version.outputs.version }}-macOS.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-dmg:
    name: Create DMG Installer
    runs-on: macos-14
    needs: create-release
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode 16.2
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Release
        run: swift build -c release

      - name: Create DMG
        run: |
          mkdir -p dmg-staging
          cp -R .build/release/Thea dmg-staging/ || cp -R .build/release/TheaPackage dmg-staging/Thea

          hdiutil create -volname "Thea ${{ steps.version.outputs.version }}" \
                         -srcfolder dmg-staging \
                         -ov -format UDZO \
                         Thea-${{ steps.version.outputs.version }}.dmg

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@v1
        with:
          files: Thea-${{ steps.version.outputs.version }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
