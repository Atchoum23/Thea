# Thea Release Workflow
# Version: 2.4.0 - Phase E: CI gate, version validation, code signing docs, auto-release notes, permissions
# Last Updated: February 18, 2026
#
# ⚠️ CODE SIGNING NOTE:
# For real distribution, the following GitHub Secrets must be configured:
#   APPLE_CERTIFICATE_BASE64    - p12 certificate exported from Keychain, base64 encoded
#   APPLE_CERTIFICATE_PASSWORD  - p12 password
#   KEYCHAIN_PASSWORD           - temporary keychain password for CI
#   APPLE_TEAM_ID               - your Apple Developer Team ID
# Until those are configured, builds use CODE_SIGNING_ALLOWED=NO (CI validation only)
# The resulting artifacts are NOT suitable for distribution to end users.

name: Thea Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.5.0)'
        required: true
        type: string

permissions: read-all

env:
  XCODE_VERSION: '26.2'
  DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel release builds

jobs:
  # ============================================
  # CI GATE — Validate CI passed before releasing
  # ============================================
  validate-ci:
    name: Validate CI Passed
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Check CI workflow status
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const ref = context.sha;
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main',
              status: 'success',
              per_page: 10,
            });
            const ciRun = runs.workflow_runs.find(r => r.name === 'Thea CI' && r.head_sha === ref);
            if (!ciRun) {
              core.setFailed(`No successful CI run found for commit ${ref}. A passing CI run is required before releasing. Trigger CI first, then re-run this workflow.`);
            } else {
              console.log('CI passed:', ciRun.html_url);
            }

  # ============================================
  # BUILD RELEASE ARTIFACTS
  # ============================================
  build-release:
    name: Build ${{ matrix.platform }} Release
    runs-on: macos-26
    needs: validate-ci
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macOS
            scheme: Thea-macOS
            destination: 'platform=macOS'
            artifact_path: 'build/Build/Products/Release/Thea.app'
          - platform: iOS
            scheme: Thea-iOS
            destination: 'generic/platform=iOS'
            artifact_path: 'build/Build/Products/Release-iphoneos/Thea.app'
          - platform: watchOS
            scheme: Thea-watchOS
            destination: 'generic/platform=watchOS'
            artifact_path: 'build/Build/Products/Release-watchos/Thea Watch.app'
          - platform: tvOS
            scheme: Thea-tvOS
            destination: 'generic/platform=tvOS'
            artifact_path: 'build/Build/Products/Release-appletvos/Thea TV.app'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Xcode and XcodeGen
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: '26.2'
          scheme: ${{ matrix.scheme }}

      - name: Cache SPM Dependencies
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: build/SourcePackages
          key: ${{ runner.os }}-${{ matrix.scheme }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.scheme }}-spm-
            ${{ runner.os }}-spm-

      - name: Resolve SPM Dependencies
        run: swift package resolve

      - name: Extract Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi

          # Validate semver format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: '$VERSION'. Must be semver (e.g. 1.2.3 or 1.2.3-beta.1)"
            exit 1
          fi
          echo "Version validated: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Import Code Signing Certificate
        continue-on-error: true
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Skip if no certificate configured (secrets context can't be used in if: conditions)
          if [ -z "$CERTIFICATE_BASE64" ]; then
            echo "No signing certificate configured — building unsigned (CI validation only)"
            exit 0
          fi
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          echo "$CERTIFICATE_BASE64" | base64 --decode > /tmp/cert.p12
          security import /tmp/cert.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          echo "CODE_SIGN_IDENTITY=Apple Development" >> $GITHUB_ENV

      - name: Build ${{ matrix.scheme }} Release
        run: |
          xcodebuild build \
            -project Thea.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION=${{ steps.version.outputs.version }} \
            2>&1 | tee build-${{ matrix.platform }}.log

      - name: Verify Build Success
        run: |
          if [ ! -d "${{ matrix.artifact_path }}" ]; then
            echo "::error::Build artifact not found at ${{ matrix.artifact_path }}"
            echo "Available artifacts:"
            find build/Build/Products -name "*.app" -type d || echo "No .app found"
            exit 1
          fi
          echo "Build successful: ${{ matrix.artifact_path }}"

      - name: Create Archive
        run: |
          mkdir -p release
          cp -R "${{ matrix.artifact_path }}" release/
          cd release
          zip -r ../Thea-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: Thea-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip
          retention-days: 90

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: release-build-log-${{ matrix.platform }}
          path: build-${{ matrix.platform }}.log
          retention-days: 30

    outputs:
      version: ${{ steps.version.outputs.version }}

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download macOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-macOS-${{ needs.build-release.outputs.version }}
          path: ./release

      - name: Download iOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-iOS-${{ needs.build-release.outputs.version }}
          path: ./release

      - name: Download watchOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-watchOS-${{ needs.build-release.outputs.version }}
          path: ./release
        continue-on-error: true

      - name: Download tvOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-tvOS-${{ needs.build-release.outputs.version }}
          path: ./release
        continue-on-error: true

      - name: Generate Release Notes
        run: |
          VERSION="${{ needs.build-release.outputs.version }}"
          PREV_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")
          echo "## Thea v${VERSION}" > release-notes.md
          echo "" >> release-notes.md
          if [ -n "$PREV_TAG" ]; then
            echo "### Changes since ${PREV_TAG}" >> release-notes.md
            git log --pretty=format:"- %s" "${PREV_TAG}..HEAD" | grep -v "^- Auto-save:" | head -50 >> release-notes.md
          fi
          echo "" >> release-notes.md
          echo "### Platforms" >> release-notes.md
          echo "- macOS 26.0+, iOS 26.0+, watchOS 26.0+, tvOS 26.0+" >> release-notes.md
          echo "" >> release-notes.md
          echo "### Requirements" >> release-notes.md
          echo "- macOS 26.0 (Tahoe) or later" >> release-notes.md
          echo "- iOS 26.0 or later" >> release-notes.md
          echo "- watchOS 26.0 or later" >> release-notes.md
          echo "- tvOS 26.0 or later" >> release-notes.md
          echo "" >> release-notes.md
          echo "*Built with Swift 6.0, zero warnings, zero errors*" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          body_path: release-notes.md
          files: release/*
          draft: false
          prerelease: ${{ contains(needs.build-release.outputs.version, 'beta') || contains(needs.build-release.outputs.version, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # CREATE DMG (macOS only)
  # ============================================
  create-dmg:
    name: Create DMG Installer
    runs-on: macos-26
    needs: [build-release, create-release]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download macOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-macOS-${{ needs.build-release.outputs.version }}
          path: ./

      - name: Extract and Create DMG
        run: |
          VERSION="${{ needs.build-release.outputs.version }}"

          # Unzip the app
          unzip -o "Thea-${VERSION}-macOS.zip" -d dmg-staging

          # Create DMG with background and layout
          hdiutil create \
            -volname "Thea ${VERSION}" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            "Thea-${VERSION}.dmg"

          # Verify DMG
          if [ ! -f "Thea-${VERSION}.dmg" ]; then
            echo "::error::DMG creation failed"
            exit 1
          fi
          echo "DMG created successfully: Thea-${VERSION}.dmg"
          ls -lh "Thea-${VERSION}.dmg"

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          files: Thea-${{ needs.build-release.outputs.version }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # RELEASE SUMMARY
  # ============================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build-release, create-release, create-dmg]
    if: always()
    steps:
      - name: Summary
        run: |
          VERSION="${{ needs.build-release.outputs.version }}"
          echo "## Release v${VERSION} Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-release.result }}" == "success" ]]; then
            echo "| Build | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "| GitHub Release | Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GitHub Release | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.create-dmg.result }}" == "success" ]]; then
            echo "| DMG Installer | Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| DMG Installer | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
