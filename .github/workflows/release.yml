# Thea Release Workflow
# Version: 3.0.0 - Fixed 7 issues (P0: CI gate, version validation, code signing; P1: auto release notes, all platform artifacts, permissions; P2: SBOM)
# Last Updated: February 17, 2026
#
# CODE SIGNING NOTE:
# For real distribution, the following GitHub Secrets must be configured:
#   APPLE_CERTIFICATE_BASE64    - p12 certificate exported from Keychain, base64 encoded
#   APPLE_CERTIFICATE_PASSWORD  - p12 password
#   KEYCHAIN_PASSWORD           - temporary keychain password for CI
#   APPLE_TEAM_ID               - your Apple Developer Team ID
# Until those are configured, builds use CODE_SIGNING_ALLOWED=NO (CI validation only)
# The resulting artifacts are NOT suitable for distribution to end users.

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.5.0)'
        required: true
        type: string

permissions: read-all

env:
  XCODE_VERSION: '26.2'
  DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel release builds

jobs:
  # ============================================
  # VALIDATE CI PASSED
  # ============================================
  validate-ci:
    name: Validate CI Passed
    runs-on: ubuntu-latest
    steps:
      - name: Check CI workflow status
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const ref = context.sha;
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch: 'main',
              status: 'success',
              per_page: 10,
            });
            const ciRun = runs.workflow_runs.find(r => r.name === 'CI' && r.head_sha === ref);
            if (!ciRun) {
              core.setFailed('No successful CI run found for this commit. Release blocked.');
            } else {
              console.log('CI passed:', ciRun.html_url);
            }

  # ============================================
  # BUILD RELEASE ARTIFACTS
  # ============================================
  build-release:
    name: Build ${{ matrix.platform }} Release
    runs-on: macos-26
    needs: validate-ci
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macOS
            scheme: Thea-macOS
            destination: 'platform=macOS'
            artifact_path: 'build/Build/Products/Release/Thea.app'
          - platform: iOS
            scheme: Thea-iOS
            destination: 'generic/platform=iOS'
            artifact_path: 'build/Build/Products/Release-iphoneos/Thea.app'
          - platform: watchOS
            scheme: Thea-watchOS
            destination: 'generic/platform=watchOS'
            artifact_path: 'build/Build/Products/Release-watchos/Thea Watch.app'
          - platform: tvOS
            scheme: Thea-tvOS
            destination: 'generic/platform=tvOS'
            artifact_path: 'build/Build/Products/Release-appletvos/Thea.app'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Xcode and XcodeGen
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: '26.2'
          scheme: ${{ matrix.scheme }}

      - name: Resolve SPM Dependencies
        run: swift package resolve

      - name: Extract Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          # Validate semver format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: '$VERSION'. Must be semver (e.g. 1.2.3 or 1.2.3-beta.1)"
            exit 1
          fi
          echo "Version validated: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Import Code Signing Certificate
        if: secrets.APPLE_CERTIFICATE_BASE64 != ''
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          echo "$CERTIFICATE_BASE64" | base64 --decode > /tmp/cert.p12
          security import /tmp/cert.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          echo "SIGNING_KEYCHAIN=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "SIGNING_ENABLED=true" >> $GITHUB_ENV

      - name: Install macOS Provisioning Profiles
        if: matrix.platform == 'macOS' && secrets.PROVISIONING_PROFILE_MACOS != ''
        env:
          PP_MACOS: ${{ secrets.PROVISIONING_PROFILE_MACOS }}
          PP_FINDER: ${{ secrets.PROVISIONING_PROFILE_FINDER_EXT }}
          PP_MAIL: ${{ secrets.PROVISIONING_PROFILE_MAIL_EXT }}
          PP_NETWORK: ${{ secrets.PROVISIONING_PROFILE_NETWORK_EXT }}
          PP_QUICKLOOK: ${{ secrets.PROVISIONING_PROFILE_QUICKLOOK_EXT }}
          PP_SPOTLIGHT: ${{ secrets.PROVISIONING_PROFILE_SPOTLIGHT_EXT }}
          PP_VPN: ${{ secrets.PROVISIONING_PROFILE_VPN_EXT }}
        run: |
          PP_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PP_DIR"
          echo "$PP_MACOS"     | base64 --decode > "$PP_DIR/Thea_macOS.provisionprofile"
          echo "$PP_FINDER"    | base64 --decode > "$PP_DIR/Thea_Finder.provisionprofile"
          echo "$PP_MAIL"      | base64 --decode > "$PP_DIR/Thea_Mail.provisionprofile"
          echo "$PP_NETWORK"   | base64 --decode > "$PP_DIR/Thea_Network.provisionprofile"
          echo "$PP_QUICKLOOK" | base64 --decode > "$PP_DIR/Thea_QuickLook.provisionprofile"
          echo "$PP_SPOTLIGHT" | base64 --decode > "$PP_DIR/Thea_Spotlight.provisionprofile"
          echo "$PP_VPN"       | base64 --decode > "$PP_DIR/Thea_VPN.provisionprofile"
          echo "Installed $(ls "$PP_DIR" | wc -l) provisioning profiles"

      - name: Build ${{ matrix.scheme }} Release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ "${{ matrix.platform }}" = "macOS" ] && [ "${SIGNING_ENABLED:-}" = "true" ]; then
            # Signed archive build for Developer ID distribution
            xcodebuild archive \
              -project Thea.xcodeproj \
              -scheme Thea-macOS \
              -destination 'platform=macOS' \
              -configuration Release \
              -archivePath $RUNNER_TEMP/Thea.xcarchive \
              OTHER_CODE_SIGN_FLAGS="--keychain '$SIGNING_KEYCHAIN'" \
              CODE_SIGN_IDENTITY="Developer ID Application: Alexis Calevras (6B66PM4JLK)" \
              CODE_SIGN_STYLE=Manual \
              DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
              MARKETING_VERSION="$VERSION" \
              ARCHS=arm64 \
              2>&1 | tee build-macOS.log
            # Export signed .app — write ExportOptions.plist via printf (no heredoc — heredocs break YAML)
            printf '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>method</key><string>developer-id</string><key>teamID</key><string>6B66PM4JLK</string><key>signingStyle</key><string>manual</string><key>stripSwiftSymbols</key><true/><key>signingCertificate</key><string>Developer ID Application</string></dict></plist>' > /tmp/ExportOptions.plist
            xcodebuild -exportArchive \
              -archivePath $RUNNER_TEMP/Thea.xcarchive \
              -exportPath $RUNNER_TEMP/export \
              -exportOptionsPlist /tmp/ExportOptions.plist \
              2>&1 | tee -a build-macOS.log
            # Notarize
            echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" > /tmp/AuthKey.p8
            ditto -c -k --keepParent "$RUNNER_TEMP/export/Thea.app" /tmp/Thea-notarize.zip
            xcrun notarytool submit /tmp/Thea-notarize.zip \
              --key /tmp/AuthKey.p8 \
              --key-id "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
              --issuer "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}" \
              --wait 2>&1
            xcrun stapler staple "$RUNNER_TEMP/export/Thea.app"
            rm -f /tmp/AuthKey.p8 /tmp/Thea-notarize.zip
            echo "SIGNED_APP_PATH=$RUNNER_TEMP/export/Thea.app" >> $GITHUB_ENV
          else
            # Unsigned build (non-macOS or no signing cert — CI validation only)
            xcodebuild build \
              -project Thea.xcodeproj \
              -scheme ${{ matrix.scheme }} \
              -destination '${{ matrix.destination }}' \
              -configuration Release \
              -derivedDataPath build \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              MARKETING_VERSION="$VERSION" \
              2>&1 | tee build-${{ matrix.platform }}.log
          fi

      - name: Verify Build Success
        run: |
          if [ "${{ matrix.platform }}" = "macOS" ] && [ "${SIGNING_ENABLED:-}" = "true" ]; then
            APP_PATH="${SIGNED_APP_PATH:-$RUNNER_TEMP/export/Thea.app}"
          else
            APP_PATH="${{ matrix.artifact_path }}"
          fi
          if [ ! -d "$APP_PATH" ]; then
            echo "::error::Build artifact not found at $APP_PATH"
            find /tmp $RUNNER_TEMP build/Build/Products -name "*.app" -type d 2>/dev/null | head -10 || true
            exit 1
          fi
          echo "Build successful: $APP_PATH"
          echo "ARTIFACT_PATH=$APP_PATH" >> $GITHUB_ENV

      - name: Create Archive
        run: |
          mkdir -p release
          APP_PATH="${ARTIFACT_PATH:-${{ matrix.artifact_path }}}"
          cp -R "$APP_PATH" release/
          cd release
          zip -r ../Thea-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: thea-${{ matrix.platform }}-${{ steps.version.outputs.version }}
          path: Thea-${{ steps.version.outputs.version }}-${{ matrix.platform }}.zip
          retention-days: 90

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: release-build-log-${{ matrix.platform }}
          path: build-${{ matrix.platform }}.log
          retention-days: 30

    outputs:
      version: ${{ steps.version.outputs.version }}

  # ============================================
  # CREATE GITHUB RELEASE
  # ============================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download macOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-macOS-${{ needs.build-release.outputs.version }}
          path: ./release

      - name: Download iOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-iOS-${{ needs.build-release.outputs.version }}
          path: ./release

      - name: Download watchOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-watchOS-${{ needs.build-release.outputs.version }}
          path: ./release
        continue-on-error: true

      - name: Download tvOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-tvOS-${{ needs.build-release.outputs.version }}
          path: ./release
        continue-on-error: true

      - name: Generate Release Notes
        run: |
          VERSION="${{ needs.build-release.outputs.version }}"
          PREV_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")
          echo "## Thea v${VERSION}" > release-notes.md
          echo "" >> release-notes.md
          if [ -n "$PREV_TAG" ]; then
            echo "### Changes since ${PREV_TAG}" >> release-notes.md
            git log --pretty=format:"- %s" "${PREV_TAG}..HEAD" | grep -v "^- Auto-save:" | head -50 >> release-notes.md
          fi
          echo "" >> release-notes.md
          echo "### Platforms" >> release-notes.md
          echo "- macOS 26.0+, iOS 26.0+, watchOS 26.0+, tvOS 26.0+" >> release-notes.md
          echo "" >> release-notes.md
          echo "### Developer Builds" >> release-notes.md
          echo "watchOS and tvOS artifacts are developer builds (unsigned)." >> release-notes.md
          echo "" >> release-notes.md
          echo "*Built with Swift 6.0, zero warnings, zero errors*" >> release-notes.md

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: release/thea-${{ needs.build-release.outputs.version }}-sbom.spdx.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          body_path: release-notes.md
          files: release/*
          draft: false
          prerelease: ${{ contains(needs.build-release.outputs.version, 'beta') || contains(needs.build-release.outputs.version, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # CREATE DMG (macOS only)
  # ============================================
  create-dmg:
    name: Create DMG Installer
    runs-on: macos-26
    needs: [build-release, create-release]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download macOS Artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: thea-macOS-${{ needs.build-release.outputs.version }}
          path: ./

      - name: Extract and Create DMG
        run: |
          VERSION="${{ needs.build-release.outputs.version }}"

          # Unzip the app
          unzip -o "Thea-${VERSION}-macOS.zip" -d dmg-staging

          # Create DMG with background and layout
          hdiutil create \
            -volname "Thea ${VERSION}" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            "Thea-${VERSION}.dmg"

          # Verify DMG
          if [ ! -f "Thea-${VERSION}.dmg" ]; then
            echo "::error::DMG creation failed"
            exit 1
          fi
          echo "DMG created successfully: Thea-${VERSION}.dmg"
          ls -lh "Thea-${VERSION}.dmg"

      - name: Upload DMG to Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          files: Thea-${{ needs.build-release.outputs.version }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # RELEASE SUMMARY
  # ============================================
  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [build-release, create-release, create-dmg]
    if: always()
    steps:
      - name: Summary
        run: |
          VERSION="${{ needs.build-release.outputs.version }}"
          echo "## Release v${VERSION} Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-release.result }}" == "success" ]]; then
            echo "| Build | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.create-release.result }}" == "success" ]]; then
            echo "| GitHub Release | Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GitHub Release | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.create-dmg.result }}" == "success" ]]; then
            echo "| DMG Installer | Created |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| DMG Installer | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
