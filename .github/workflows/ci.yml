# Thea CI/CD Pipeline
# Version: 5.0.0 - Tiered coverage gates: 70% overall / 100% critical classes / 100% branch on security files
# Last Updated: February 18, 2026

name: Thea CI

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/*.md'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options: [Debug, Release]

permissions: read-all

env:
  XCODE_VERSION: '26.2'
  DEVELOPER_DIR: /Applications/Xcode_26.2.app/Contents/Developer

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  # ============================================
  # SWIFTLINT - Strict enforcement
  # ============================================
  swiftlint:
    name: SwiftLint
    runs-on: macos-26
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cache SwiftLint
        id: swiftlint-cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: /opt/homebrew/Cellar/swiftlint
          key: ${{ runner.os }}-swiftlint-0.57.0

      - name: Install SwiftLint
        run: |
          if [ "${{ steps.swiftlint-cache.outputs.cache-hit }}" == "true" ]; then
            brew link swiftlint 2>/dev/null || true
          fi
          command -v swiftlint || brew install swiftlint

      - name: Run SwiftLint
        run: |
          # --strict converts warnings to errors; exit 2 means violations found.
          # warning_threshold: 0 was removed from .swiftlint.yml (0.63.2 self-fires at 0 >= 0).
          swiftlint lint --strict --reporter github-actions-logging
          EXIT=$?
          if [ $EXIT -eq 2 ]; then
            echo "::error::SwiftLint found violations (exit code 2)"
            exit 2
          fi
          exit $EXIT

      - name: Generate Report
        if: always()
        run: swiftlint lint --reporter json > swiftlint-report.json 2>/dev/null || true

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: swiftlint-report
          path: swiftlint-report.json
          if-no-files-found: ignore
          retention-days: 7

  # ============================================
  # BUILD ALL PLATFORMS (Matrix Strategy)
  # ============================================
  build:
    name: Build ${{ matrix.platform }}
    runs-on: macos-26
    needs: swiftlint
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: iOS
            scheme: Thea-iOS
            destination: 'generic/platform=iOS'
          - platform: macOS
            scheme: Thea-macOS
            destination: 'platform=macOS'
          - platform: watchOS
            scheme: Thea-watchOS
            destination: 'generic/platform=watchOS'
          - platform: tvOS
            scheme: Thea-tvOS
            destination: 'generic/platform=tvOS'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Xcode and XcodeGen
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: '26.2'
          scheme: ${{ matrix.scheme }}

      - name: Cache DerivedData
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: build
          key: ${{ runner.os }}-${{ matrix.scheme }}-deriveddata-${{ hashFiles('project.yml', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.scheme }}-deriveddata-

      - name: Resolve SPM Dependencies
        run: swift package resolve

      - name: Validate Package.swift
        run: |
          # Validate SPM manifest syntax (integrated from dependencies.yml)
          xcrun swift package dump-package > /dev/null 2>&1 || {
            echo "::error::Package.swift has invalid syntax"
            exit 1
          }
          echo "Package.swift validated successfully"

      - name: Build ${{ matrix.scheme }}
        run: |
          xcodebuild build \
            -project Thea.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration ${{ inputs.configuration || 'Debug' }} \
            -derivedDataPath build \
            -resultBundlePath build/results-${{ matrix.platform }}.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build-${{ matrix.platform }}.log

      - name: Check for Warnings
        run: |
          WARNINGS=$(grep -c " warning:" build-${{ matrix.platform }}.log 2>/dev/null || true)
          WARNINGS=${WARNINGS:-0}
          echo "warnings_count=$WARNINGS" >> $GITHUB_OUTPUT
          echo "Warnings found: $WARNINGS"
          if [ "$WARNINGS" -gt 0 ]; then
            echo "::error::${{ matrix.platform }} build has $WARNINGS warning(s) — target is 0"
            grep " warning:" build-${{ matrix.platform }}.log | head -20 || true
            exit 1
          fi

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: build-log-${{ matrix.platform }}
          path: build-${{ matrix.platform }}.log
          retention-days: 7

      - name: Upload Build Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: build-results-${{ matrix.platform }}
          path: build/results-${{ matrix.platform }}.xcresult
          if-no-files-found: ignore
          retention-days: 7

  # ============================================
  # UNIT TESTS (macOS + iOS Simulator)
  # ============================================
  test:
    name: Unit Tests
    runs-on: macos-26
    needs: build
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Xcode and XcodeGen
        uses: ./.github/actions/setup-xcode
        with:
          xcode-version: '26.2'
          scheme: Thea-macOS

      - name: Cache DerivedData
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: build
          key: ${{ runner.os }}-Thea-macOS-deriveddata-${{ hashFiles('project.yml', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-Thea-macOS-deriveddata-

      - name: Run SPM Tests (Fast)
        run: |
          xcrun swift test 2>&1 | tee test-spm.log
          echo "SPM tests completed"

      - name: Run macOS Tests
        run: |
          xcodebuild test \
            -project Thea.xcodeproj \
            -scheme Thea-macOS \
            -destination 'platform=macOS' \
            -configuration ${{ inputs.configuration || 'Debug' }} \
            -derivedDataPath build \
            -resultBundlePath build/test-results-macos.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test-macos.log

      - name: Run iOS Simulator Tests
        run: |
          # Get available iPhone simulator using robust python3 selection
          SIMULATOR=$(xcrun simctl list devices available --json | python3 -c "
          import json,sys
          devices=json.load(sys.stdin)['devices']
          for runtime,devs in sorted(devices.items(), reverse=True):
            if 'iOS' not in runtime: continue
            for d in devs:
              if 'iPhone 16' in d['name']:
                print(d['udid']); sys.exit(0)
          for runtime,devs in sorted(devices.items(), reverse=True):
            if 'iOS' not in runtime: continue
            for d in devs:
              if 'iPhone 15' in d['name']:
                print(d['udid']); sys.exit(0)
          for runtime,devs in sorted(devices.items(), reverse=True):
            if 'iOS' not in runtime: continue
            for d in devs:
              if 'iPhone' in d['name']:
                print(d['udid']); sys.exit(0)
          sys.exit(1)
          ") || { echo "::error::No iPhone simulator found"; exit 1; }
          echo "Using simulator: $SIMULATOR"

          xcodebuild test \
            -project Thea.xcodeproj \
            -scheme Thea-iOS \
            -destination "platform=iOS Simulator,id=$SIMULATOR" \
            -configuration ${{ inputs.configuration || 'Debug' }} \
            -derivedDataPath build \
            -resultBundlePath build/test-results-ios.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test-ios.log

      - name: Export Coverage
        if: always()
        run: |
          xcrun xccov view --report --json build/test-results-macos.xcresult > coverage-macos.json 2>/dev/null || true
          xcrun xccov view --report --json build/test-results-ios.xcresult > coverage-ios.json 2>/dev/null || true

      - name: Check Coverage Threshold (≥70% overall)
        if: always()
        run: |
          # 70% is the realistic ceiling once SwiftUI views (~30% of codebase)
          # are excluded from unit tests (they are covered by Maestro E2E instead).
          # Business logic and security layers are gated harder by separate steps below.
          if [ -f coverage-macos.json ]; then
            python3 -c "
          import json,sys
          try:
            d=json.load(open('coverage-macos.json'))
            cov=d.get('lineCoverage',0)
            print(f'macOS overall line coverage: {cov:.1%}')
            if cov < 0.70:
              print(f'::error::macOS overall coverage {cov:.1%} is below 70% minimum')
              sys.exit(1)
          except Exception as e:
            print(f'Could not parse coverage: {e}')
          "
          fi

      - name: Check Critical Class Coverage (100% target)
        if: always()
        run: |
          # Service/Manager/Engine/Pipeline/Orchestrator/Controller/Coordinator classes
          # must have 100% line coverage — no business logic ships untested.
          if [ ! -f coverage-macos.json ]; then
            echo "::warning::No coverage-macos.json — skipping critical class check"
            exit 0
          fi
          python3 << 'PYEOF'
          import json, sys

          CRITICAL_SUFFIXES = (
              'Service.swift', 'Manager.swift', 'Engine.swift',
              'Pipeline.swift', 'Orchestrator.swift', 'Controller.swift',
              'Coordinator.swift',
          )
          THRESHOLD = 1.0  # 100%

          try:
              d = json.load(open('coverage-macos.json'))
              targets = d.get('targets', [])

              checked = []
              failures = []

              for target in targets:
                  for file in target.get('files', []):
                      name = file.get('name', '')
                      if not name.endswith(CRITICAL_SUFFIXES):
                          continue
                      cov = file.get('lineCoverage', 0.0)
                      checked.append((name, cov))
                      if cov < THRESHOLD:
                          failures.append((name, cov))

              if not checked:
                  print('No critical class files found in coverage data — nothing to check')
                  sys.exit(0)

              print(f'Critical class coverage ({len(checked)} files):')
              for name, cov in sorted(checked):
                  mark = 'PASS' if cov >= THRESHOLD else 'FAIL'
                  print(f'  [{mark}] {name}: {cov:.1%}')

              if failures:
                  print(f'\n::error::{len(failures)} critical class file(s) below 100% coverage:')
                  for name, cov in sorted(failures):
                      print(f'  {name}: {cov:.1%}')
                  sys.exit(1)
              else:
                  print(f'\nAll {len(checked)} critical class files at 100% coverage')

          except Exception as e:
              print(f'::warning::Could not parse coverage data: {e}')
              sys.exit(0)
          PYEOF

      - name: Check Security-Critical File Coverage (100% branch)
        if: always()
        run: |
          # These 5 files are the security perimeter. A missed branch here means
          # a credential leak, prompt injection, or privacy violation can slip through.
          # Branch coverage (not just line) is required: every if/guard/switch arm tested.
          if [ ! -f coverage-macos.json ]; then
            echo "::warning::No coverage-macos.json — skipping security file branch check"
            exit 0
          fi
          python3 << 'PYEOF'
          import json, sys

          SECURITY_FILES = {
              'OutboundPrivacyGuard.swift',
              'OpenClawSecurityGuard.swift',
              'FunctionGemmaBridge.swift',
              'ConversationLanguageService.swift',
              'OpenClawBridge.swift',
          }
          THRESHOLD = 1.0  # 100% branch coverage

          try:
              d = json.load(open('coverage-macos.json'))
              targets = d.get('targets', [])

              found = {}
              for target in targets:
                  for file in target.get('files', []):
                      name = file.get('name', '')
                      if name in SECURITY_FILES:
                          line_cov = file.get('lineCoverage', 0.0)
                          # branchCoverage available in Xcode 13+ xccov JSON
                          branch_cov = file.get('branchCoverage', None)
                          found[name] = (line_cov, branch_cov)

              missing = SECURITY_FILES - found.keys()
              if missing:
                  print(f'::warning::Security files not found in coverage data (not in macOS target?): {", ".join(sorted(missing))}')

              failures = []
              print(f'Security-critical file branch coverage ({len(found)} files):')
              for name in sorted(found):
                  line_cov, branch_cov = found[name]
                  if branch_cov is None:
                      # Fall back to line coverage if branch data unavailable
                      effective = line_cov
                      note = 'line (branch data unavailable)'
                  else:
                      effective = branch_cov
                      note = 'branch'
                  mark = 'PASS' if effective >= THRESHOLD else 'FAIL'
                  print(f'  [{mark}] {name}: {effective:.1%} {note}')
                  if effective < THRESHOLD:
                      failures.append((name, effective, note))

              if failures:
                  print(f'\n::error::{len(failures)} security-critical file(s) below 100% branch coverage:')
                  for name, cov, note in sorted(failures):
                      print(f'  {name}: {cov:.1%} {note} — every branch must be tested')
                  sys.exit(1)
              else:
                  print(f'\nAll {len(found)} security-critical files at 100% branch coverage')

          except Exception as e:
              print(f'::warning::Could not parse coverage data: {e}')
              sys.exit(0)
          PYEOF

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: test-results
          path: |
            build/test-results-*.xcresult
            test-*.log
            coverage-*.json
          if-no-files-found: ignore
          retention-days: 30

  # ============================================
  # CODECOV & SONARCLOUD (Parallel)
  # ============================================
  codecov:
    name: CodeCov Upload
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Coverage
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: test-results
          path: ./
        continue-on-error: true

      - name: Upload to CodeCov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: Atchoum23/Thea
          files: ./coverage-macos.json,./coverage-ios.json
          flags: unittests
          fail_ci_if_error: false
          verbose: true

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true
    permissions:
      contents: read
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download SwiftLint Report
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: swiftlint-report
          path: ./
        continue-on-error: true

      - name: SonarCloud Scan
        # sonarcloud-github-action v5 is deprecated (exits code 3). Use sonarqube-scan-action v7+.
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================
  # QUALITY GATE
  # ============================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [swiftlint, build, test]
    permissions:
      contents: read
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # SwiftLint
          if [[ "${{ needs.swiftlint.result }}" == "success" ]]; then
            echo "| SwiftLint | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SwiftLint | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Builds
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| All Platform Builds | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| All Platform Builds | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Tests
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "| Unit Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical checks failed
        if: needs.swiftlint.result == 'failure' || needs.build.result == 'failure' || needs.test.result == 'failure'
        run: |
          echo "::error::Critical checks failed"
          exit 1
