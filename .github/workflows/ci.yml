# Thea CI/CD Pipeline
# Version: 3.1.0 - Optimized with matrix builds, strict error handling, pinned actions
# Last Updated: January 27, 2026

name: CI

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options: [Debug, Release]

env:
  XCODE_VERSION: '16.2'
  DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # SWIFTLINT - Strict enforcement
  # ============================================
  swiftlint:
    name: SwiftLint
    runs-on: macos-14
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Cache SwiftLint
        id: swiftlint-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: /opt/homebrew/Cellar/swiftlint
          key: ${{ runner.os }}-swiftlint-0.57.0

      - name: Install SwiftLint
        run: |
          if [ "${{ steps.swiftlint-cache.outputs.cache-hit }}" == "true" ]; then
            brew link swiftlint 2>/dev/null || true
          fi
          command -v swiftlint || brew install swiftlint

      - name: Run SwiftLint (Strict)
        run: swiftlint lint --strict --reporter github-actions-logging

      - name: Generate Report
        if: always()
        run: swiftlint lint --reporter json > swiftlint-report.json 2>/dev/null || true

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: swiftlint-report
          path: swiftlint-report.json
          if-no-files-found: ignore
          retention-days: 7

  # ============================================
  # BUILD ALL PLATFORMS (Matrix Strategy)
  # ============================================
  build:
    name: Build ${{ matrix.platform }}
    runs-on: macos-14
    needs: swiftlint
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: iOS
            scheme: Thea-iOS
            destination: 'generic/platform=iOS'
          - platform: macOS
            scheme: Thea-macOS
            destination: 'platform=macOS'
          - platform: watchOS
            scheme: Thea-watchOS
            destination: 'generic/platform=watchOS'
          - platform: tvOS
            scheme: Thea-tvOS
            destination: 'generic/platform=tvOS'

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache XcodeGen
        id: xcodegen-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: /opt/homebrew/Cellar/xcodegen
          key: ${{ runner.os }}-xcodegen-2.42.0

      - name: Install XcodeGen
        run: |
          if [ "${{ steps.xcodegen-cache.outputs.cache-hit }}" == "true" ]; then
            brew link xcodegen 2>/dev/null || true
          fi
          command -v xcodegen || brew install xcodegen

      - name: Cache SPM Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.1.2
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Build ${{ matrix.scheme }}
        run: |
          xcodebuild build \
            -project Thea.xcodeproj \
            -scheme ${{ matrix.scheme }} \
            -destination '${{ matrix.destination }}' \
            -configuration ${{ inputs.configuration || 'Release' }} \
            -resultBundlePath build/results-${{ matrix.platform }}.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build-${{ matrix.platform }}.log

      - name: Check for Warnings
        run: |
          WARNINGS=$(grep -c " warning:" build-${{ matrix.platform }}.log || echo "0")
          echo "warnings_count=$WARNINGS" >> $GITHUB_OUTPUT
          echo "Warnings found: $WARNINGS"
          if [ "$WARNINGS" -gt 0 ]; then
            echo "::warning::${{ matrix.platform }} build has $WARNINGS warnings"
            grep " warning:" build-${{ matrix.platform }}.log | head -20
          fi

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: build-log-${{ matrix.platform }}
          path: build-${{ matrix.platform }}.log
          retention-days: 7

      - name: Upload Build Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: build-results-${{ matrix.platform }}
          path: build/results-${{ matrix.platform }}.xcresult
          if-no-files-found: ignore
          retention-days: 7

  # ============================================
  # UNIT TESTS (macOS + iOS Simulator)
  # ============================================
  test:
    name: Unit Tests
    runs-on: macos-14
    needs: build
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Select Xcode ${{ env.XCODE_VERSION }}
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache XcodeGen
        id: xcodegen-cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: /opt/homebrew/Cellar/xcodegen
          key: ${{ runner.os }}-xcodegen-2.42.0

      - name: Install XcodeGen
        run: |
          if [ "${{ steps.xcodegen-cache.outputs.cache-hit }}" == "true" ]; then
            brew link xcodegen 2>/dev/null || true
          fi
          command -v xcodegen || brew install xcodegen

      - name: Cache SPM Dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.1.2
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Run macOS Tests
        run: |
          xcodebuild test \
            -project Thea.xcodeproj \
            -scheme Thea-macOS \
            -destination 'platform=macOS' \
            -configuration Debug \
            -resultBundlePath build/test-results-macos.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test-macos.log

      - name: Run iOS Simulator Tests
        run: |
          # Get available iPhone simulator
          SIMULATOR=$(xcrun simctl list devices available | grep "iPhone 16" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
          if [ -z "$SIMULATOR" ]; then
            SIMULATOR=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*(\([^)]*\)).*/\1/')
          fi
          echo "Using simulator: $SIMULATOR"

          xcodebuild test \
            -project Thea.xcodeproj \
            -scheme Thea-iOS \
            -destination "platform=iOS Simulator,id=$SIMULATOR" \
            -configuration Debug \
            -resultBundlePath build/test-results-ios.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test-ios.log

      - name: Export Coverage
        if: always()
        run: |
          xcrun xccov view --report --json build/test-results-macos.xcresult > coverage-macos.json 2>/dev/null || true
          xcrun xccov view --report --json build/test-results-ios.xcresult > coverage-ios.json 2>/dev/null || true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: test-results
          path: |
            build/test-results-*.xcresult
            test-*.log
            coverage-*.json
          if-no-files-found: ignore
          retention-days: 30

  # ============================================
  # CODECOV & SONARCLOUD (Parallel)
  # ============================================
  codecov:
    name: CodeCov Upload
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Coverage
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: test-results
          path: ./
        continue-on-error: true

      - name: Upload to CodeCov
        uses: codecov/codecov-action@1e68e06f1571f8627f4ede8f8a1659b00b01f393 # v5.1.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          slug: Atchoum23/Thea
          files: ./coverage-macos.json,./coverage-ios.json
          flags: unittests
          fail_ci_if_error: false
          verbose: true

  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Download SwiftLint Report
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: swiftlint-report
          path: ./
        continue-on-error: true

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@aa494459d7c39c106cc77b166de8b4250a32bb97 # v4.2.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================
  # QUALITY GATE
  # ============================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [swiftlint, build, test]
    if: always()
    steps:
      - name: Check Results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # SwiftLint
          if [[ "${{ needs.swiftlint.result }}" == "success" ]]; then
            echo "| SwiftLint | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SwiftLint | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Builds
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "| All Platform Builds | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| All Platform Builds | Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Tests
          if [[ "${{ needs.test.result }}" == "success" ]]; then
            echo "| Unit Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical checks failed
        if: needs.swiftlint.result == 'failure' || needs.build.result == 'failure' || needs.test.result == 'failure'
        run: |
          echo "::error::Critical checks failed"
          exit 1
